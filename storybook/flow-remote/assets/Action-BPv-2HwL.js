var T=Object.defineProperty;var V=(o,t,e)=>t in o?T(o,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):o[t]=e;var r=(o,t,e)=>V(o,typeof t!="symbol"?t+"":t,e);import{r as d,R as x}from"./index-Cs7sjTYM.js";import{u as $,O as G}from"./context-BnMUo41h.js";import{i as L}from"./Text-DbnY-2dT.js";import{m as O,o as I,b as g,c as E,u as U,f as j}from"./flowComponent-Bg40pdZw.js";import{u as v}from"./useSelector-DiJHxpbu.js";import{P as q}from"./PropsContextProvider-DXo7lD_U.js";import{d as l}from"./dynamic-DKDa4OpU.js";const w=d.createContext(void 0),z=w.Provider,B=o=>new Promise(t=>setTimeout(t,o)),A={pending:1e3,succeeded:1500,failed:2e3};class P{constructor(){r(this,"showFeedback");r(this,"state","isIdle");r(this,"setPendingTimeout");r(this,"error");r(this,"isAsync",!1);O(this,{state:I,updateState:g,isBusy:E})}static useNew(){return d.useRef(new P).current}updateState(t){this.state=t}useValue(){return v(()=>this.state,[this])}useIsBusy(){return v(()=>this.isBusy,[this])}get isBusy(){return this.state!=="isIdle"}onAsyncStart(){this.isAsync=!0,this.updateState("isExecuting"),this.setPendingTimeout=window.setTimeout(()=>this.startPending(),A.pending)}async onSucceeded(){await this.onDone()}async onFailed(t){this.error=t??new Error("Unknown error"),await this.onDone()}withFeedback(t){return this.showFeedback=t,this}async startFailedFeedback(){this.updateState("isFailed"),await B(A.failed),this.resetAfterDone()}async startSucceededFeedback(){this.updateState("isSucceeded"),await B(A.succeeded),this.resetAfterDone()}resetAfterDone(){this.updateState("isIdle"),this.isAsync=!1,this.error=void 0}async onDone(){this.setPendingTimeout&&window.clearTimeout(this.setPendingTimeout),this.error?await this.startFailedFeedback():this.showFeedback!==!1&&(this.showFeedback||this.isAsync)?await this.startSucceededFeedback():this.resetAfterDone()}startPending(){this.updateState("isPending")}}const N=o=>(...t)=>{const e=[...o],n=e.shift();if(n){const s=n(...t),a=()=>e.length===0?s:N(e)(...t);return s instanceof Promise?s.then(a):a()}},m=()=>{},H=(o,t={})=>{const{onSync:e=m,onAsync:n=m,then:s=m,catch:a=m,finally:c=m}=t;try{const i=o();return i instanceof Promise?(n(),i.then(s).catch(a).finally(c)):(e(),s(i),c(),i)}catch(i){e(),a(i),c()}},F=()=>{};function J(o){var f,h,S;if(o.needsConfirmation)return o.confirmationModalController.open;const t=y=>typeof y=="string"?o.getOverlayController(y):y,{action:e,onAction:n=e,toggleOverlay:s,closeOverlay:a,openOverlay:c}=o.actionProps;return(n||(c?(f=t(c))==null?void 0:f.open:a?(h=t(a))==null?void 0:h.close:s?(S=t(s))==null?void 0:S.toggle:F))??F}class k{constructor(t){r(this,"actions",[]);r(this,"baseAction");this.baseAction=t}addAction(t){this.actions.push(t)}async executeBatch(t){if(this.actions.length===0)return;const e=this.actions[this.actions.length-1].actionProps.showFeedback,n=this.baseAction.state.withFeedback(this.baseAction.needsConfirmation?!1:e),s=this.actions.map(i=>J(i)),a=N(s);let c;if(await H(()=>a(...t),{onAsync:()=>n.onAsyncStart(),then:()=>n.onSucceeded(),catch:i=>{n.onFailed(i),c=i}}),c)throw c}}class K{constructor(t){r(this,"action");r(this,"execute",(...t)=>{const e=this.getBatchedActions();(async()=>{for(const s of e)await s.executeBatch(t)})().catch(s=>console.error(s))});r(this,"getBatchedActions",()=>{let t=this.action;const e=[];let n=new k(this.action),s=0;for(;t;){const{action:a,break:c,skip:i}=t.actionProps;if(t.needsConfirmation){n.addAction(t);break}if(i){s=i===!0?1:i,t=t.parentAction;continue}if(s>0){t=t.parentAction,s--;continue}if(c)break;a||(e.push(n),n=new k(this.action)),n.addAction(t),t=t.parentAction}return e.push(n),e});this.action=t}}class p{constructor(){r(this,"states",new Set);O(this,{states:I,addState:g,removeState:g,isBusy:E})}static useNew(){return d.useRef(new p).current}static useRegisterState(t){const e=R();d.useEffect(()=>(e==null||e.addState(t),()=>{e==null||e.removeState(t)}),[e,t])}addState(t){this.states.add(t)}removeState(t){this.states.delete(t)}useIsBusy(){return v(()=>this.isBusy)}get isBusy(){for(const t of this.states)if(t.isBusy)return!0;return!1}}const D=d.createContext(void 0),Q=o=>{const{children:t}=o,e=p.useNew();return x.createElement(D.Provider,{value:e},t)},R=()=>{const o=p.useNew();return d.useContext(D)??o};Q.__docgenInfo={description:"",methods:[],displayName:"ActionStateContextProvider"};class u{constructor(t){r(this,"state");r(this,"needsConfirmation");r(this,"actionProps");r(this,"parentAction");r(this,"confirmationModalController");r(this,"overlayContext");r(this,"execute",(...t)=>{new K(this).execute(...t)});const{actionProps:e,needsConfirmation:n,parentAction:s,overlayContext:a,confirmationModalController:c,state:i}=t;this.actionProps=e,this.parentAction=s,this.confirmationModalController=c,this.needsConfirmation=n,this.overlayContext=a,this.state=i}static useNew(t,e={}){const n=d.useContext(w),s=$(),a=G.useNew(),c=P.useNew();return new u({parentAction:n,overlayContext:s,confirmationModalController:a,needsConfirmation:!1,actionProps:t,state:c,...e})}static use(){const t=d.useContext(w);return L(!!t,"Action context is not defined"),p.useRegisterState(t.state),t}static useConfirmationAction(){const t=u.use();return new u({actionProps:t.actionProps,confirmationModalController:t.confirmationModalController,overlayContext:t.overlayContext,state:t.state,needsConfirmation:!1,parentAction:u.useNew({closeOverlay:t.confirmationModalController},{parentAction:t.parentAction})})}getOverlayController(t){const e=n=>n===void 0?void 0:n?this.overlayContext[t]:void 0;return e(this.actionProps.openOverlay)??e(this.actionProps.closeOverlay)??e(this.actionProps.toggleOverlay)}}const W=o=>U()[o],X=o=>{const{slot:t,...e}=o,n=e.color===void 0||e.color==="primary"||e.color==="danger"||e.color==="accent"?"primary":"abort";return t??n},b=o=>W("Modal")==="actionConfirm"?X(o):void 0,C=o=>{const t=u.use(),e=t.state.useValue(),n=b(o)==="primary",s=t.confirmationModalController.useIsOpen();return t.needsConfirmation&&s&&!n?"isIdle":e},M={onPress:l(o=>{const t=u.use(),e=u.useConfirmationAction(),n=b(o)==="primary";return b(o)==="abort"?t.confirmationModalController.close:n?e.execute:t.execute}),isPending:l(o=>C(o)==="isPending"),isSucceeded:l(o=>C(o)==="isSucceeded"),isFailed:l(o=>C(o)==="isFailed"),"aria-disabled":l(o=>{const t=C(o),e=R().useIsBusy();return t==="isExecuting"||e})},Y=j("Action",o=>{const{children:t,actionModel:e,...n}=o,s=u.useNew(n),a=e??s,c={Button:M,Link:{onPress:l(()=>u.use().execute)},MenuItem:{onAction:l(()=>u.use().execute)},Modal:{slot:l(i=>{const{slot:f}=i,h=u.use();return h.needsConfirmation=f==="actionConfirm",f}),isDismissable:l(i=>{const h=u.use().state.useValue();return h==="isExecuting"||h==="isPending"?!1:i.isDismissable}),controller:l(()=>{const i=u.use();return i.needsConfirmation?i.confirmationModalController:i.getOverlayController("Modal")}),ActionGroup:{Button:M}}};return x.createElement(z,{value:a},x.createElement(q,{props:c,mergeInParentContext:!0},t))});Y.__docgenInfo={description:"",methods:[],displayName:"Action"};export{Y as A,Q as a,u as b,X as g,B as s};

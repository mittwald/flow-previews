import{r as C,j as b}from"./iframe-CO_SbVCH.js";import{u as B,O as F}from"./context-BbDJJF8K.js";import{i as k}from"./browser-DqZUP5aL.js";import{m as M,c as O,b as I,o as E,u as D,f as T,P as N}from"./flowComponent-CeLLqyNG.js";import{u as j,a as g}from"./useStatic-D6cqHfiz.js";import{A as R,g as V,u as $}from"./getActionGroupSlot-DAKAs_h9.js";import{d as u}from"./dynamic-7BzGeVfl.js";const A=C.createContext(void 0),G=A.Provider,w=e=>new Promise(t=>setTimeout(t,e)),m={pending:1e3,succeeded:1500,failed:2e3};class x{showFeedback;state="isIdle";setPendingTimeout;error;isAsync=!1;constructor(){M(this,{state:E,updateState:I,isBusy:O})}static useNew(){return j(()=>new x)}updateState(t){this.state=t}useValue(){return g(()=>this.state,[this])}useIsBusy(){return g(()=>this.isBusy,[this])}get isBusy(){return this.state!=="isIdle"}onAsyncStart(){this.isAsync=!0,this.updateState("isExecuting"),this.setPendingTimeout=window.setTimeout(()=>this.startPending(),m.pending)}async onSucceeded(){await this.onDone()}async onFailed(t){this.error=t??new Error("Unknown error"),await this.onDone()}withFeedback(t){return this.showFeedback=t,this}async startFailedFeedback(){this.updateState("isFailed"),await w(m.failed),this.resetAfterDone()}async startSucceededFeedback(){this.updateState("isSucceeded"),await w(m.succeeded),this.resetAfterDone()}resetAfterDone(){this.updateState("isIdle"),this.isAsync=!1,this.error=void 0}async onDone(){this.setPendingTimeout&&window.clearTimeout(this.setPendingTimeout),this.error?await this.startFailedFeedback():this.showFeedback!==!1&&(this.showFeedback||this.isAsync)?await this.startSucceededFeedback():this.resetAfterDone()}startPending(){this.updateState("isPending")}}const S=e=>(...t)=>{const n=[...e],o=n.shift();if(o){const i=o(...t),a=()=>n.length===0?i:S(n)(...t);return i instanceof Promise?i.then(a):a()}},l=()=>{},L=(e,t={})=>{const{onSync:n=l,onAsync:o=l,then:i=l,catch:a=l,finally:c=l}=t;try{const s=e();return s instanceof Promise?(o(),s.then(i).catch(a).finally(c)):(n(),i(s),c(),s)}catch(s){n(),a(s),c()}},v=()=>{};function U(e){if(e.needsConfirmation)return e.confirmationModalController.open;const t=s=>typeof s=="string"?e.getOverlayController(s):s,{onAction:n,toggleOverlay:o,closeOverlay:i,openOverlay:a}=e.actionProps;return(n||(a?t(a)?.open:i?t(i)?.close:o?t(o)?.toggle:v))??v}class P{actions=[];baseAction;constructor(t){this.baseAction=t}addAction(t){this.actions.push(t)}async executeBatch(t){if(this.actions.length===0)return;const n=this.actions[this.actions.length-1]?.actionProps.showFeedback,o=this.baseAction.state.withFeedback(this.baseAction.needsConfirmation?!1:n),i=this.actions.map(s=>U(s)),a=S(i);let c;if(await L(()=>a(...t),{onAsync:()=>o.onAsyncStart(),then:()=>o.onSucceeded(),catch:s=>{o.onFailed(s),c=s}}),c)throw c}}class q{action;constructor(t){this.action=t}execute=(...t)=>{const n=this.getBatchedActions();(async()=>{for(const i of n)await i.executeBatch(t)})().catch(i=>console.error(i))};getBatchedActions=()=>{let t=this.action;const n=[];let o=new P(this.action),i=0;for(;t;){const{onAction:a,break:c,skip:s}=t.actionProps;if(t.needsConfirmation){o.addAction(t);break}if(s){i=s===!0?1:s,t=t.parentAction;continue}if(i>0){t=t.parentAction,i--;continue}if(c)break;a||(n.push(o),o=new P(this.action)),o.addAction(t),t=t.parentAction}return n.push(o),n}}class r{state;needsConfirmation;actionProps;parentAction;confirmationModalController;overlayContext;constructor(t){const{actionProps:n,needsConfirmation:o,parentAction:i,overlayContext:a,confirmationModalController:c,state:s}=t;this.actionProps=n,this.parentAction=i,this.confirmationModalController=c,this.needsConfirmation=o,this.overlayContext=a,this.state=s}static useNew(t,n={}){const o=C.useContext(A),i=B(),a=F.useNew(),c=x.useNew();return new r({parentAction:o,overlayContext:i,confirmationModalController:a,needsConfirmation:!1,actionProps:t,state:c,...n})}static use(){const t=C.useContext(A);return k(!!t,"Action context is not defined"),R.useRegisterState(t.state),t}static useConfirmationAction(){const t=r.use();return new r({actionProps:t.actionProps,confirmationModalController:t.confirmationModalController,overlayContext:t.overlayContext,state:t.state,needsConfirmation:!1,parentAction:r.useNew({closeOverlay:t.confirmationModalController},{parentAction:t.parentAction})})}getOverlayController(t){const n=o=>o===void 0?void 0:o?this.overlayContext[t]:void 0;return n(this.actionProps.openOverlay)??n(this.actionProps.closeOverlay)??n(this.actionProps.toggleOverlay)}execute=(...t)=>{new q(this).execute(...t)}}const z=e=>D()[e],y=e=>z("Modal")==="actionConfirm"?V(e):void 0,h=e=>{const t=r.use(),n=t.state.useValue(),o=y(e)==="primary",i=t.confirmationModalController.useIsOpen();return t.needsConfirmation&&i&&!o?"isIdle":n},p={onPress:u(e=>{const t=r.use(),n=r.useConfirmationAction(),o=y(e)==="primary";return y(e)==="abort"?t.confirmationModalController.close:o?n.execute:t.execute}),isPending:u(e=>{const t=h(e);return e.isPending??t==="isPending"}),isSucceeded:u(e=>{const t=h(e);return e.isSucceeded??t==="isSucceeded"}),isFailed:u(e=>{const t=h(e);return e.isFailed??t==="isFailed"}),"aria-disabled":u(e=>{const t=h(e),n=$().useIsBusy();return e["aria-disabled"]??(t==="isExecuting"||n)})},Z=T("Action",e=>{const{children:t,actionModel:n,...o}=e,i=r.useNew(o),a=n??i,c={Button:p,SubmitButton:p,Link:{onPress:u(()=>r.use().execute)},MenuItem:{onAction:u(()=>r.use().execute)},Modal:{slot:u(s=>{const{slot:f}=s,d=r.use();return d.needsConfirmation=f==="actionConfirm",f}),isDismissable:u(s=>{const d=r.use().state.useValue();return d==="isExecuting"||d==="isPending"?!1:s.isDismissable}),controller:u(()=>{const s=r.use();return s.needsConfirmation?s.confirmationModalController:s.getOverlayController("Modal")}),ActionGroup:{Button:p}}};return b.jsx(G,{value:a,children:b.jsx(N,{props:c,children:t})})},{type:"provider"});export{Z as A,r as a,w as s};

import{r as p,j as x}from"./iframe-DN5oj4yX.js";import{u as B,O as P}from"./context-BOqeUKEn.js";import{m as O,c as k,b as I,o as E,u as T,f as D,P as N}from"./flowComponent-D5tzpGYQ.js";import{i as j}from"./browser-t02O3gv-.js";import{u as V,a as v}from"./useStatic-D8kDoy_M.js";import{d as l}from"./dynamic-D_PfG4t1.js";import{A as G,g as R,u as F}from"./getActionGroupSlot-B3lnxGbD.js";const C=p.createContext(void 0),U=C.Provider,S=e=>new Promise(t=>setTimeout(t,e)),m={pending:1e3,succeeded:1500,failed:2e3};class g{showFeedback;state="isIdle";setPendingTimeout;error;isAsync=!1;constructor(){O(this,{state:E,updateState:I,isBusy:k})}static useNew(){return V(()=>new g)}updateState(t){this.state=t}useValue(){return v(()=>this.state,[this])}useIsBusy(){return v(()=>this.isBusy,[this])}get isBusy(){return this.state!=="isIdle"}onAsyncStart(){this.clearPendingTimeout(),this.isAsync=!0,this.updateState("isExecuting"),this.setPendingTimeout=window.setTimeout(()=>this.startPending(),m.pending)}async onSucceeded(){await this.onDone()}async onFailed(t){this.error=t??new Error("Unknown error"),await this.onDone()}withFeedback(t){return this.showFeedback=t,this}async startFailedFeedback(){this.updateState("isFailed"),await S(m.failed),this.resetAfterDone()}async startSucceededFeedback(){this.updateState("isSucceeded"),await S(m.succeeded),this.resetAfterDone()}resetAfterDone(){this.updateState("isIdle"),this.isAsync=!1,this.error=void 0}clearPendingTimeout(){this.setPendingTimeout&&window.clearTimeout(this.setPendingTimeout)}onDone(){if(this.clearPendingTimeout(),this.error)return this.startFailedFeedback();if(this.showFeedback!==!1&&(this.showFeedback||this.isAsync))return this.startSucceededFeedback();this.resetAfterDone()}startPending(){this.updateState("isPending")}}const y=e=>(...t)=>{const n=[...e],o=n.shift();if(o){const i=o(...t),c=()=>n.length===0?i:y(n)(...t);return i instanceof Promise?i.then(c):c()}},b=()=>{};function L(e){if(e.needsConfirmation)return e.confirmationModalController.open;const{onAction:t,toggleOverlay:n,closeOverlay:o,openOverlay:i,openModal:c,closeModal:u,toggleModal:s}=e.actionProps;return(t||(i?()=>e.getOverlayController(i)?.open():o?()=>e.getOverlayController(o)?.close():n?()=>e.getOverlayController(n)?.toggle():c?()=>e.getOverlayController("Modal")?.open():s?()=>e.getOverlayController("Modal")?.toggle():u?()=>e.getOverlayController("Modal")?.close():b))??b}class w{actions=[];baseAction;constructor(t){this.baseAction=t}addAction(t){this.actions.push(t)}executeBatch(...t){if(this.actions.length===0)return;const n=this.actions[this.actions.length-1]?.actionProps.showFeedback,o=this.baseAction.state.withFeedback(this.baseAction.needsConfirmation?!1:n),i=this.actions.map(a=>L(a)),c=y(i),u=a=>{throw o.onFailed(a),a},s=()=>o.onSucceeded();try{const a=c(...t);return a instanceof Promise?(o.onAsyncStart(),a.then(s).catch(u)):(s(),a)}catch(a){u(a)}}}class ${action;constructor(t){this.action=t}execute=(...t)=>{const n=this.getBatchedActions();y(n.map(i=>i.executeBatch.bind(i)))(...t)};getBatchedActions=()=>{let t=this.action;const n=[];let o=new w(this.action),i=0;for(;t;){const{onAction:c,break:u,skip:s}=t.actionProps;if(t.needsConfirmation){o.addAction(t);break}if(s){i=s===!0?1:s,t=t.parentAction;continue}if(i>0){t=t.parentAction,i--;continue}if(u)break;c||(n.push(o),o=new w(this.action)),o.addAction(t),t=t.parentAction}return n.push(o),n}}class r{state;needsConfirmation;actionProps;parentAction;confirmationModalController;overlayContext;constructor(t){const{actionProps:n,needsConfirmation:o,parentAction:i,overlayContext:c,confirmationModalController:u,state:s}=t;this.actionProps=n,this.parentAction=i,this.confirmationModalController=u,this.needsConfirmation=o,this.overlayContext=c,this.state=s}static useNew(t,n={}){const o=p.useContext(C),i=B(),c=P.useNew(),u=g.useNew();return new r({parentAction:o,overlayContext:i,confirmationModalController:c,needsConfirmation:!1,actionProps:t,state:u,...n})}static use(){const t=p.useContext(C);return j(!!t,"Action context is not defined"),G.useRegisterState(t.state),t}static useConfirmationAction(){const t=r.use();return new r({actionProps:t.actionProps,confirmationModalController:t.confirmationModalController,overlayContext:t.overlayContext,state:t.state,needsConfirmation:!1,parentAction:r.useNew({closeOverlay:t.confirmationModalController},{parentAction:t.parentAction})})}getOverlayController(t){const n=o=>{if(o!==void 0){if(t instanceof P)return t;if(typeof t=="string")return this.overlayContext[t]}};return n(this.actionProps.openOverlay)??n(this.actionProps.closeOverlay)??n(this.actionProps.toggleOverlay)??n(this.actionProps.openModal?"Modal":void 0)??n(this.actionProps.closeModal?"Modal":void 0)??n(this.actionProps.toggleModal?"Modal":void 0)}execute=(...t)=>{new $(this).execute(...t)}}const q=e=>T()[e],A=e=>q("Modal")==="actionConfirm"?R(e):void 0,h=e=>{const t=r.use(),n=t.state.useValue(),o=A(e)==="primary",i=t.confirmationModalController.useIsOpen();return t.needsConfirmation&&i&&!o?"isIdle":n},f=()=>r.use().state.useValue(),M={onPress:l(e=>{const t=r.use(),n=r.useConfirmationAction(),o=A(e)==="primary";return A(e)==="abort"?t.confirmationModalController.close:o?n.execute:t.execute}),isPending:l(e=>{const t=h(e);return e.isPending??t==="isPending"}),isSucceeded:l(e=>{const t=h(e);return e.isSucceeded??t==="isSucceeded"}),isFailed:l(e=>{const t=h(e);return e.isFailed??t==="isFailed"}),"aria-disabled":l(e=>{const t=h(e),n=F().useIsBusy();return e["aria-disabled"]??(t==="isExecuting"||n)})},Y=D("Action",e=>{const{children:t,actionModel:n,...o}=e;"action"in o&&typeof o.action=="function"&&(console.warn("The 'action' prop is now deprecated. Use 'onAction' instead."),"onAction"in o||(o.onAction=o.action));const i=r.useNew(o),c=n??i,u={Button:M,Link:{onPress:l(()=>r.use().execute)},MenuItem:{onAction:l(()=>r.use().execute),isPending:l(s=>{const a=f();return s.isPending??a==="isPending"}),isSucceeded:l(s=>{const a=f();return s.isSucceeded??a==="isSucceeded"}),isFailed:l(s=>{const a=f();return s.isFailed??a==="isFailed"}),"aria-disabled":l(s=>{const a=f(),d=F().useIsBusy();return s["aria-disabled"]??(a==="isExecuting"||d)})},Modal:{slot:l(s=>{const{slot:a}=s,d=r.use();return d.needsConfirmation=a==="actionConfirm",a}),isDismissable:l(s=>{const d=r.use().state.useValue();return d==="isExecuting"||d==="isPending"?!1:s.isDismissable}),controller:l(()=>{const s=r.use();return s.needsConfirmation?s.confirmationModalController:s.getOverlayController("Modal")}),ActionGroup:{Button:M}}};return x.jsx(U,{value:c,children:x.jsx(N,{props:u,children:t})})},{type:"provider"});export{Y as A,r as a,S as s};

var k=Object.defineProperty;var S=(o,e,t)=>e in o?k(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var c=(o,e,t)=>(S(o,typeof e!="symbol"?e+"":e,t),t);import{r as m,R as A}from"./index-uCp2LrAq.js";import{u as b}from"./useOverlayController-BEtHDaPX.js";import{i as B}from"./Text-D2IU3xaq.js";import{m as F,o as O,b as I,c as M,u as T}from"./flowComponent-ICaMEJBy.js";import{u as w}from"./useSelector-D8Q7WzRc.js";import{a as E,g as D,u as q}from"./getActionGroupSlot-BAmoc-3q.js";import{P as N}from"./PropsContextProvider-RdMO5ekw.js";import{d as u}from"./dynamic-DKDa4OpU.js";const p=m.createContext(void 0),R=p.Provider,v=o=>new Promise(e=>setTimeout(e,o)),f={pending:1e3,succeeded:1500,failed:2e3};class C{constructor(){c(this,"showFeedback");c(this,"state","isIdle");c(this,"setPendingTimeout");c(this,"error");c(this,"isAsync",!1);F(this,{state:O,updateState:I,isBusy:M})}static useNew(){return m.useRef(new C).current}updateState(e){this.state=e}useValue(){return w(()=>this.state,[this])}useIsBusy(){return w(()=>this.isBusy,[this])}get isBusy(){return this.state==="isExecuting"||this.state==="isPending"}onAsyncStart(){this.isAsync=!0,this.updateState("isExecuting"),this.setPendingTimeout=window.setTimeout(()=>this.startPending(),f.pending)}async onSucceeded(){await this.onDone()}async onFailed(e){this.error=e??new Error("Unknown error"),await this.onDone()}withFeedback(e){return this.showFeedback=e,this}async startFailedFeedback(){this.updateState("isFailed"),await v(f.failed),this.resetAfterDone()}async startSucceededFeedback(){this.updateState("isSucceeded"),await v(f.succeeded),this.resetAfterDone()}resetAfterDone(){this.updateState("isIdle"),this.isAsync=!1,this.error=void 0}async onDone(){this.setPendingTimeout&&window.clearTimeout(this.setPendingTimeout),this.error?await this.startFailedFeedback():this.showFeedback!==!1&&(this.showFeedback||this.isAsync)?await this.startSucceededFeedback():this.resetAfterDone()}startPending(){this.updateState("isPending")}}const x=o=>(...e)=>{const t=[...o],s=t.shift();if(s){const i=s(...e),n=()=>t.length===0?i:x(t)(...e);return i instanceof Promise?i.then(n):n()}},d=()=>{},$=(o,e={})=>{const{onSync:t=d,onAsync:s=d,then:i=d,catch:n=d,finally:r=d}=e;try{const a=o();return a instanceof Promise?(s(),a.then(i).catch(n).finally(r)):(t(),i(a),r(),a)}catch(a){t(),n(a),r()}},V=()=>{};function G(o){if(o.needsConfirmation)return o.confirmationModalController.open;const e=o.getOverlayController(),{action:t,toggleOverlay:s,closeOverlay:i,openOverlay:n}=o.actionProps;return t||(n&&e?e.open:i&&e||s&&e?e.close:V)}class g{constructor(e){c(this,"actions",[]);c(this,"baseAction");this.baseAction=e}addAction(e){this.actions.push(e)}async executeBatch(e){if(this.actions.length===0)return;const t=this.actions[this.actions.length-1].actionProps.showFeedback,s=this.baseAction.state.withFeedback(this.baseAction.needsConfirmation?!1:t),i=this.actions.map(a=>G(a)),n=x(i);let r;if(await $(()=>n(...e),{onAsync:()=>s.onAsyncStart(),then:()=>s.onSucceeded(),catch:a=>{s.onFailed(a),r=a}}),r)throw r}}class L{constructor(e){c(this,"action");c(this,"execute",(...e)=>{const t=this.getBatchedActions();(async()=>{for(const i of t)await i.executeBatch(e)})().catch(i=>console.error(i))});c(this,"getBatchedActions",()=>{let e=this.action;const t=[];let s=new g(this.action),i=0;for(;e;){const{action:n,break:r,skip:a}=e.actionProps;if(e.needsConfirmation){s.addAction(e);break}if(a){i=a===!0?1:a,e=e.parentAction;continue}if(i>0){e=e.parentAction,i--;continue}if(r)break;n||(t.push(s),s=new g(this.action)),s.addAction(e),e=e.parentAction}return t.push(s),t});this.action=e}}class l{constructor(e){c(this,"state");c(this,"needsConfirmation");c(this,"actionProps");c(this,"parentAction");c(this,"confirmationModalController");c(this,"overlayController");c(this,"execute",(...e)=>{new L(this).execute(...e)});const{actionProps:t,needsConfirmation:s,parentAction:i,overlayController:n,confirmationModalController:r,state:a}=e;this.actionProps=t,this.parentAction=i,this.confirmationModalController=r,this.needsConfirmation=s,this.overlayController=n,this.state=a}static useNew(e,t={}){const s=m.useContext(p),i=b(),n=b(),r=C.useNew();return new l({parentAction:s,overlayController:i,confirmationModalController:n,needsConfirmation:!1,actionProps:e,state:r,...t})}static use(){const e=m.useContext(p);return B(!!e,"Action context is not defined"),E.useRegisterState(e.state),e}static useConfirmationAction(){const e=l.use();return new l({actionProps:e.actionProps,confirmationModalController:e.confirmationModalController,overlayController:e.overlayController,state:e.state,needsConfirmation:!1,parentAction:l.useNew({closeOverlay:!0},{parentAction:e.parentAction})})}getOverlayController(){const e=t=>t===void 0?void 0:t===!0?this.overlayController:t===!1?void 0:t;return e(this.actionProps.openOverlay)??e(this.actionProps.closeOverlay)??e(this.actionProps.toggleOverlay)}}const U=o=>T()[o],y=o=>U("Modal")==="actionConfirm"?D(o):void 0,h=o=>{const e=l.use(),t=e.state.useValue(),s=y(o)==="primary",i=e.confirmationModalController.useIsOpen();return e.needsConfirmation&&i&&!s?"isIdle":t},W=o=>{const{children:e,...t}=o,s=l.useNew(t),i={Button:{onPress:u(n=>{const r=l.use(),a=l.useConfirmationAction(),P=y(n)==="primary";return y(n)==="abort"?r.confirmationModalController.close:P?a.execute:r.execute}),isPending:u(n=>h(n)==="isPending"),isSucceeded:u(n=>h(n)==="isSucceeded"),isFailed:u(n=>h(n)==="isFailed"),"aria-disabled":u(()=>{const n=h(o),r=q().useIsBusy();return n==="isExecuting"||r})},Link:{onPress:u(()=>l.use().execute)},Modal:{slot:u(n=>{const{slot:r}=n,a=l.use();return a.needsConfirmation=r==="actionConfirm",r}),isDismissable:u(n=>l.use().state.useIsBusy()?!1:n.isDismissable),controller:u(()=>{const n=l.use();return n.needsConfirmation?n.confirmationModalController:n.getOverlayController()})}};return A.createElement(R,{value:s},A.createElement(N,{props:i,mergeInParentContext:!0},e))};W.__docgenInfo={description:"",methods:[],displayName:"Action",props:{action:{required:!1,tsType:{name:"signature",type:"function",raw:"(...args: unknown[]) => unknown",signature:{arguments:[{type:{name:"Array",elements:[{name:"unknown"}],raw:"unknown[]"},name:"args",rest:!0}],return:{name:"unknown"}}},description:""},closeOverlay:{required:!1,tsType:{name:"union",raw:"boolean | OverlayController",elements:[{name:"boolean"},{name:"OverlayController"}]},description:""},openOverlay:{required:!1,tsType:{name:"union",raw:"boolean | OverlayController",elements:[{name:"boolean"},{name:"OverlayController"}]},description:""},toggleOverlay:{required:!1,tsType:{name:"union",raw:"boolean | OverlayController",elements:[{name:"boolean"},{name:"OverlayController"}]},description:""},break:{required:!1,tsType:{name:"boolean"},description:""},skip:{required:!1,tsType:{name:"union",raw:"number | boolean",elements:[{name:"number"},{name:"boolean"}]},description:""},showFeedback:{required:!1,tsType:{name:"boolean"},description:""}},composes:["PropsWithChildren"]};export{W as A,v as s};

var k=Object.defineProperty;var S=(n,t,e)=>t in n?k(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var a=(n,t,e)=>(S(n,typeof t!="symbol"?t+"":t,e),e);import{r as m,R as A}from"./index-uCp2LrAq.js";import{u as b}from"./useOverlayController-BEtHDaPX.js";import{i as F}from"./Text-D2IU3xaq.js";import{m as B,o as O,b as M,c as T,u as I}from"./flowComponent-ICaMEJBy.js";import{u as w}from"./useSelector-D8Q7WzRc.js";import{a as E,g as D,u as q}from"./getActionGroupSlot-l9Qp8VQ-.js";import{P as N}from"./PropsContextProvider-RdMO5ekw.js";import{d as u}from"./dynamic-DKDa4OpU.js";const p=m.createContext(void 0),R=p.Provider,v=n=>new Promise(t=>setTimeout(t,n)),f={pending:1e3,succeeded:1500,failed:2e3};class C{constructor(){a(this,"showFeedback");a(this,"state","isIdle");a(this,"setPendingTimeout");a(this,"error");a(this,"isAsync",!1);B(this,{state:O,updateState:M,isBusy:T})}static useNew(){return m.useRef(new C).current}updateState(t){this.state=t}useValue(){return w(()=>this.state,[this])}useIsBusy(){return w(()=>this.isBusy,[this])}get isBusy(){return this.state!=="isIdle"}onAsyncStart(){this.isAsync=!0,this.updateState("isExecuting"),this.setPendingTimeout=window.setTimeout(()=>this.startPending(),f.pending)}async onSucceeded(){await this.onDone()}async onFailed(t){this.error=t??new Error("Unknown error"),await this.onDone()}withFeedback(t){return this.showFeedback=t,this}async startFailedFeedback(){this.updateState("isFailed"),await v(f.failed),this.resetAfterDone()}async startSucceededFeedback(){this.updateState("isSucceeded"),await v(f.succeeded),this.resetAfterDone()}resetAfterDone(){this.updateState("isIdle"),this.isAsync=!1,this.error=void 0}async onDone(){this.setPendingTimeout&&window.clearTimeout(this.setPendingTimeout),this.error?await this.startFailedFeedback():this.showFeedback!==!1&&(this.showFeedback||this.isAsync)?await this.startSucceededFeedback():this.resetAfterDone()}startPending(){this.updateState("isPending")}}const P=n=>(...t)=>{const e=[...n],o=e.shift();if(o){const s=o(...t),i=()=>e.length===0?s:P(e)(...t);return s instanceof Promise?s.then(i):i()}},d=()=>{},V=(n,t={})=>{const{onSync:e=d,onAsync:o=d,then:s=d,catch:i=d,finally:c=d}=t;try{const r=n();return r instanceof Promise?(o(),r.then(s).catch(i).finally(c)):(e(),s(r),c(),r)}catch(r){e(),i(r),c()}},$=()=>{};function G(n){if(n.needsConfirmation)return n.confirmationModalController.open;const t=n.getOverlayController(),{action:e,toggleOverlay:o,closeOverlay:s,openOverlay:i}=n.actionProps;return e||(i&&t?t.open:s&&t||o&&t?t.close:$)}class g{constructor(t){a(this,"actions",[]);a(this,"baseAction");this.baseAction=t}addAction(t){this.actions.push(t)}async executeBatch(t){if(this.actions.length===0)return;const e=this.actions[this.actions.length-1].actionProps.showFeedback,o=this.baseAction.state.withFeedback(this.baseAction.needsConfirmation?!1:e),s=this.actions.map(r=>G(r)),i=P(s);let c;if(await V(()=>i(...t),{onAsync:()=>o.onAsyncStart(),then:()=>o.onSucceeded(),catch:r=>{o.onFailed(r),c=r}}),c)throw c}}class L{constructor(t){a(this,"action");a(this,"execute",(...t)=>{const e=this.getBatchedActions();(async()=>{for(const s of e)await s.executeBatch(t)})().catch(s=>console.error(s))});a(this,"getBatchedActions",()=>{let t=this.action;const e=[];let o=new g(this.action),s=0;for(;t;){const{action:i,break:c,skip:r}=t.actionProps;if(t.needsConfirmation){o.addAction(t);break}if(r){s=r===!0?1:r,t=t.parentAction;continue}if(s>0){t=t.parentAction,s--;continue}if(c)break;i||(e.push(o),o=new g(this.action)),o.addAction(t),t=t.parentAction}return e.push(o),e});this.action=t}}class l{constructor(t){a(this,"state");a(this,"needsConfirmation");a(this,"actionProps");a(this,"parentAction");a(this,"confirmationModalController");a(this,"overlayController");a(this,"execute",(...t)=>{new L(this).execute(...t)});const{actionProps:e,needsConfirmation:o,parentAction:s,overlayController:i,confirmationModalController:c,state:r}=t;this.actionProps=e,this.parentAction=s,this.confirmationModalController=c,this.needsConfirmation=o,this.overlayController=i,this.state=r}static useNew(t,e={}){const o=m.useContext(p),s=b(),i=b(),c=C.useNew();return new l({parentAction:o,overlayController:s,confirmationModalController:i,needsConfirmation:!1,actionProps:t,state:c,...e})}static use(){const t=m.useContext(p);return F(!!t,"Action context is not defined"),E.useRegisterState(t.state),t}static useConfirmationAction(){const t=l.use();return new l({actionProps:t.actionProps,confirmationModalController:t.confirmationModalController,overlayController:t.overlayController,state:t.state,needsConfirmation:!1,parentAction:l.useNew({closeOverlay:!0},{parentAction:t.parentAction})})}getOverlayController(){const t=e=>e===void 0?void 0:e===!0?this.overlayController:e===!1?void 0:e;return t(this.actionProps.openOverlay)??t(this.actionProps.closeOverlay)??t(this.actionProps.toggleOverlay)}}const U=n=>I()[n],y=n=>U("Modal")==="actionConfirm"?D(n):void 0,h=n=>{const t=l.use(),e=t.state.useValue(),o=y(n)==="primary",s=t.confirmationModalController.useIsOpen();return t.needsConfirmation&&s&&!o?"isIdle":e},x={onPress:u(n=>{const t=l.use(),e=l.useConfirmationAction(),o=y(n)==="primary";return y(n)==="abort"?t.confirmationModalController.close:o?e.execute:t.execute}),isPending:u(n=>h(n)==="isPending"),isSucceeded:u(n=>h(n)==="isSucceeded"),isFailed:u(n=>h(n)==="isFailed"),"aria-disabled":u(n=>{const t=h(n),e=q().useIsBusy();return t==="isExecuting"||e})},W=n=>{const{children:t,...e}=n,o=l.useNew(e),s={Button:x,Link:{onPress:u(()=>l.use().execute)},Modal:{slot:u(i=>{const{slot:c}=i,r=l.use();return r.needsConfirmation=c==="actionConfirm",c}),isDismissable:u(i=>{const r=l.use().state.useValue();return r==="isExecuting"||r==="isPending"?!1:i.isDismissable}),controller:u(()=>{const i=l.use();return i.needsConfirmation?i.confirmationModalController:i.getOverlayController()}),ActionGroup:{Button:x}}};return A.createElement(R,{value:o},A.createElement(N,{props:s,mergeInParentContext:!0},t))};W.__docgenInfo={description:"",methods:[],displayName:"Action",props:{action:{required:!1,tsType:{name:"signature",type:"function",raw:"(...args: unknown[]) => unknown",signature:{arguments:[{type:{name:"Array",elements:[{name:"unknown"}],raw:"unknown[]"},name:"args",rest:!0}],return:{name:"unknown"}}},description:""},closeOverlay:{required:!1,tsType:{name:"union",raw:"boolean | OverlayController",elements:[{name:"boolean"},{name:"OverlayController"}]},description:""},openOverlay:{required:!1,tsType:{name:"union",raw:"boolean | OverlayController",elements:[{name:"boolean"},{name:"OverlayController"}]},description:""},toggleOverlay:{required:!1,tsType:{name:"union",raw:"boolean | OverlayController",elements:[{name:"boolean"},{name:"OverlayController"}]},description:""},break:{required:!1,tsType:{name:"boolean"},description:""},skip:{required:!1,tsType:{name:"union",raw:"number | boolean",elements:[{name:"number"},{name:"boolean"}]},description:""},showFeedback:{required:!1,tsType:{name:"boolean"},description:""}},composes:["PropsWithChildren"]};export{W as A,v as s};

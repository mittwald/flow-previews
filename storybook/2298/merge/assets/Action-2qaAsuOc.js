import{r as p,j as g}from"./iframe-DITN2CQJ.js";import{u as B,O as k}from"./context-DvDSM24h.js";import{i as M}from"./browser-BAwbicjx.js";import{m as O,c as I,b as E,o as T,u as D,f as N,P as j}from"./flowComponent-dTWTX0ol.js";import{u as V,a as P}from"./useStatic-CpFYvUzY.js";import{A as G,g as R,u as F}from"./getActionGroupSlot-ZZyd_ZT4.js";import{d as u}from"./dynamic-BTg8la0V.js";const C=p.createContext(void 0),U=C.Provider,S=n=>new Promise(t=>setTimeout(t,n)),m={pending:1e3,succeeded:1500,failed:2e3};class x{showFeedback;state="isIdle";setPendingTimeout;error;isAsync=!1;constructor(){O(this,{state:T,updateState:E,isBusy:I})}static useNew(){return V(()=>new x)}updateState(t){this.state=t}useValue(){return P(()=>this.state,[this])}useIsBusy(){return P(()=>this.isBusy,[this])}get isBusy(){return this.state!=="isIdle"}onAsyncStart(){this.clearPendingTimeout(),this.isAsync=!0,this.updateState("isExecuting"),this.setPendingTimeout=window.setTimeout(()=>this.startPending(),m.pending)}async onSucceeded(){await this.onDone()}async onFailed(t){this.error=t??new Error("Unknown error"),await this.onDone()}withFeedback(t){return this.showFeedback=t,this}async startFailedFeedback(){this.updateState("isFailed"),await S(m.failed),this.resetAfterDone()}async startSucceededFeedback(){this.updateState("isSucceeded"),await S(m.succeeded),this.resetAfterDone()}resetAfterDone(){this.updateState("isIdle"),this.isAsync=!1,this.error=void 0}clearPendingTimeout(){this.setPendingTimeout&&window.clearTimeout(this.setPendingTimeout)}onDone(){if(this.clearPendingTimeout(),this.error)return this.startFailedFeedback();if(this.showFeedback!==!1&&(this.showFeedback||this.isAsync))return this.startSucceededFeedback();this.resetAfterDone()}startPending(){this.updateState("isPending")}}const y=n=>(...t)=>{const o=[...n],e=o.shift();if(e){const i=e(...t),r=()=>o.length===0?i:y(o)(...t);return i instanceof Promise?i.then(r):r()}},b=()=>{};function L(n){if(n.needsConfirmation)return n.confirmationModalController.open;const t=s=>typeof s=="string"?n.getOverlayController(s):s,{onAction:o,toggleOverlay:e,closeOverlay:i,openOverlay:r}=n.actionProps;return(o||(r?t(r)?.open:i?t(i)?.close:e?t(e)?.toggle:b))??b}class w{actions=[];baseAction;constructor(t){this.baseAction=t}addAction(t){this.actions.push(t)}executeBatch(...t){if(this.actions.length===0)return;const o=this.actions[this.actions.length-1]?.actionProps.showFeedback,e=this.baseAction.state.withFeedback(this.baseAction.needsConfirmation?!1:o),i=this.actions.map(a=>L(a)),r=y(i),d=a=>{throw e.onFailed(a),a},s=()=>e.onSucceeded();try{const a=r(...t);return a instanceof Promise?(e.onAsyncStart(),a.then(s).catch(d)):(s(),a)}catch(a){d(a)}}}class ${action;constructor(t){this.action=t}execute=(...t)=>{const o=this.getBatchedActions();y(o.map(i=>i.executeBatch.bind(i)))(...t)};getBatchedActions=()=>{let t=this.action;const o=[];let e=new w(this.action),i=0;for(;t;){const{onAction:r,break:d,skip:s}=t.actionProps;if(t.needsConfirmation){e.addAction(t);break}if(s){i=s===!0?1:s,t=t.parentAction;continue}if(i>0){t=t.parentAction,i--;continue}if(d)break;r||(o.push(e),e=new w(this.action)),e.addAction(t),t=t.parentAction}return o.push(e),o}}class c{state;needsConfirmation;actionProps;parentAction;confirmationModalController;overlayContext;constructor(t){const{actionProps:o,needsConfirmation:e,parentAction:i,overlayContext:r,confirmationModalController:d,state:s}=t;this.actionProps=o,this.parentAction=i,this.confirmationModalController=d,this.needsConfirmation=e,this.overlayContext=r,this.state=s}static useNew(t,o={}){const e=p.useContext(C),i=B(),r=k.useNew(),d=x.useNew();return new c({parentAction:e,overlayContext:i,confirmationModalController:r,needsConfirmation:!1,actionProps:t,state:d,...o})}static use(){const t=p.useContext(C);return M(!!t,"Action context is not defined"),G.useRegisterState(t.state),t}static useConfirmationAction(){const t=c.use();return new c({actionProps:t.actionProps,confirmationModalController:t.confirmationModalController,overlayContext:t.overlayContext,state:t.state,needsConfirmation:!1,parentAction:c.useNew({closeOverlay:t.confirmationModalController},{parentAction:t.parentAction})})}getOverlayController(t){const o=e=>e===void 0?void 0:e?this.overlayContext[t]:void 0;return o(this.actionProps.openOverlay)??o(this.actionProps.closeOverlay)??o(this.actionProps.toggleOverlay)}execute=(...t)=>{new $(this).execute(...t)}}const q=n=>D()[n],A=n=>q("Modal")==="actionConfirm"?R(n):void 0,h=n=>{const t=c.use(),o=t.state.useValue(),e=A(n)==="primary",i=t.confirmationModalController.useIsOpen();return t.needsConfirmation&&i&&!e?"isIdle":o},f=()=>c.use().state.useValue(),v={onPress:u(n=>{const t=c.use(),o=c.useConfirmationAction(),e=A(n)==="primary";return A(n)==="abort"?t.confirmationModalController.close:e?o.execute:t.execute}),isPending:u(n=>{const t=h(n);return n.isPending??t==="isPending"}),isSucceeded:u(n=>{const t=h(n);return n.isSucceeded??t==="isSucceeded"}),isFailed:u(n=>{const t=h(n);return n.isFailed??t==="isFailed"}),"aria-disabled":u(n=>{const t=h(n),o=F().useIsBusy();return n["aria-disabled"]??(t==="isExecuting"||o)})},Y=N("Action",n=>{const{children:t,actionModel:o,...e}=n;"action"in e&&typeof e.action=="function"&&(console.warn("The 'action' prop is now deprecated. Use 'onAction' instead."),"onAction"in e||(e.onAction=e.action));const i=c.useNew(e),r=o??i,d={Button:v,Link:{onPress:u(()=>c.use().execute)},MenuItem:{onAction:u(()=>c.use().execute),isPending:u(s=>{const a=f();return s.isPending??a==="isPending"}),isSucceeded:u(s=>{const a=f();return s.isSucceeded??a==="isSucceeded"}),isFailed:u(s=>{const a=f();return s.isFailed??a==="isFailed"}),"aria-disabled":u(s=>{const a=f(),l=F().useIsBusy();return s["aria-disabled"]??(a==="isExecuting"||l)})},Modal:{slot:u(s=>{const{slot:a}=s,l=c.use();return l.needsConfirmation=a==="actionConfirm",a}),isDismissable:u(s=>{const l=c.use().state.useValue();return l==="isExecuting"||l==="isPending"?!1:s.isDismissable}),controller:u(()=>{const s=c.use();return s.needsConfirmation?s.confirmationModalController:s.getOverlayController("Modal")}),ActionGroup:{Button:v}}};return g.jsx(U,{value:r,children:g.jsx(j,{props:d,children:t})})},{type:"provider"});export{Y as A,c as a,S as s};

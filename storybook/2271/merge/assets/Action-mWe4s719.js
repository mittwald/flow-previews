import{r as p,j as g}from"./iframe-BZLAsPNC.js";import{u as F,O as B}from"./context-Wd_RxxmY.js";import{i as k}from"./browser-D75BLayN.js";import{m as M,c as O,b as I,o as T,u as D,f as E,P as N}from"./flowComponent-DRacmL0k.js";import{u as j,a as w}from"./useStatic-CJRmLxnl.js";import{A as R,g as V,u as $}from"./getActionGroupSlot-SLjFrrTu.js";import{d as u}from"./dynamic-DRBl70hS.js";const A=p.createContext(void 0),G=A.Provider,b=n=>new Promise(t=>setTimeout(t,n)),m={pending:1e3,succeeded:1500,failed:2e3};class y{showFeedback;state="isIdle";setPendingTimeout;error;isAsync=!1;constructor(){M(this,{state:T,updateState:I,isBusy:O})}static useNew(){return j(()=>new y)}updateState(t){this.state=t}useValue(){return w(()=>this.state,[this])}useIsBusy(){return w(()=>this.isBusy,[this])}get isBusy(){return this.state!=="isIdle"}onAsyncStart(){this.clearPendingTimeout(),this.isAsync=!0,this.updateState("isExecuting"),this.setPendingTimeout=window.setTimeout(()=>this.startPending(),m.pending)}async onSucceeded(){await this.onDone()}async onFailed(t){this.error=t??new Error("Unknown error"),await this.onDone()}withFeedback(t){return this.showFeedback=t,this}async startFailedFeedback(){this.updateState("isFailed"),await b(m.failed),this.resetAfterDone()}async startSucceededFeedback(){this.updateState("isSucceeded"),await b(m.succeeded),this.resetAfterDone()}resetAfterDone(){this.updateState("isIdle"),this.isAsync=!1,this.error=void 0}clearPendingTimeout(){this.setPendingTimeout&&window.clearTimeout(this.setPendingTimeout)}async onDone(){this.clearPendingTimeout(),this.error?await this.startFailedFeedback():this.showFeedback!==!1&&(this.showFeedback||this.isAsync)?await this.startSucceededFeedback():this.resetAfterDone()}startPending(){this.updateState("isPending")}}const x=n=>(...t)=>{const o=[...n],e=o.shift();if(e){const s=e(...t),a=()=>o.length===0?s:x(o)(...t);return s instanceof Promise?s.then(a):a()}},l=()=>{},U=(n,t={})=>{const{onSync:o=l,onAsync:e=l,then:s=l,catch:a=l,finally:c=l}=t;try{const i=n();return i instanceof Promise?(e(),i.then(s).catch(a).finally(c)):(o(),s(i),c(),i)}catch(i){o(),a(i),c()}},P=()=>{};function L(n){if(n.needsConfirmation)return n.confirmationModalController.open;const t=i=>typeof i=="string"?n.getOverlayController(i):i,{onAction:o,toggleOverlay:e,closeOverlay:s,openOverlay:a}=n.actionProps;return(o||(a?t(a)?.open:s?t(s)?.close:e?t(e)?.toggle:P))??P}class v{actions=[];baseAction;constructor(t){this.baseAction=t}addAction(t){this.actions.push(t)}executeBatch(...t){if(this.actions.length===0)return;const o=this.actions[this.actions.length-1]?.actionProps.showFeedback,e=this.baseAction.state.withFeedback(this.baseAction.needsConfirmation?!1:o),s=this.actions.map(c=>L(c)),a=x(s);return U(()=>a(...t),{onAsync:()=>e.onAsyncStart(),then:()=>e.onSucceeded(),catch:c=>{throw e.onFailed(c),c}})}}class q{action;constructor(t){this.action=t}execute=(...t)=>{const o=this.getBatchedActions();x(o.map(s=>s.executeBatch.bind(s)))(...t)};getBatchedActions=()=>{let t=this.action;const o=[];let e=new v(this.action),s=0;for(;t;){const{onAction:a,break:c,skip:i}=t.actionProps;if(t.needsConfirmation){e.addAction(t);break}if(i){s=i===!0?1:i,t=t.parentAction;continue}if(s>0){t=t.parentAction,s--;continue}if(c)break;a||(o.push(e),e=new v(this.action)),e.addAction(t),t=t.parentAction}return o.push(e),o}}class r{state;needsConfirmation;actionProps;parentAction;confirmationModalController;overlayContext;constructor(t){const{actionProps:o,needsConfirmation:e,parentAction:s,overlayContext:a,confirmationModalController:c,state:i}=t;this.actionProps=o,this.parentAction=s,this.confirmationModalController=c,this.needsConfirmation=e,this.overlayContext=a,this.state=i}static useNew(t,o={}){const e=p.useContext(A),s=F(),a=B.useNew(),c=y.useNew();return new r({parentAction:e,overlayContext:s,confirmationModalController:a,needsConfirmation:!1,actionProps:t,state:c,...o})}static use(){const t=p.useContext(A);return k(!!t,"Action context is not defined"),R.useRegisterState(t.state),t}static useConfirmationAction(){const t=r.use();return new r({actionProps:t.actionProps,confirmationModalController:t.confirmationModalController,overlayContext:t.overlayContext,state:t.state,needsConfirmation:!1,parentAction:r.useNew({closeOverlay:t.confirmationModalController},{parentAction:t.parentAction})})}getOverlayController(t){const o=e=>e===void 0?void 0:e?this.overlayContext[t]:void 0;return o(this.actionProps.openOverlay)??o(this.actionProps.closeOverlay)??o(this.actionProps.toggleOverlay)}execute=(...t)=>{new q(this).execute(...t)}}const z=n=>D()[n],C=n=>z("Modal")==="actionConfirm"?V(n):void 0,h=n=>{const t=r.use(),o=t.state.useValue(),e=C(n)==="primary",s=t.confirmationModalController.useIsOpen();return t.needsConfirmation&&s&&!e?"isIdle":o},S={onPress:u(n=>{const t=r.use(),o=r.useConfirmationAction(),e=C(n)==="primary";return C(n)==="abort"?t.confirmationModalController.close:e?o.execute:t.execute}),isPending:u(n=>{const t=h(n);return n.isPending??t==="isPending"}),isSucceeded:u(n=>{const t=h(n);return n.isSucceeded??t==="isSucceeded"}),isFailed:u(n=>{const t=h(n);return n.isFailed??t==="isFailed"}),"aria-disabled":u(n=>{const t=h(n),o=$().useIsBusy();return n["aria-disabled"]??(t==="isExecuting"||o)})},Z=E("Action",n=>{const{children:t,actionModel:o,...e}=n;"action"in e&&typeof e.action=="function"&&(console.warn("The 'action' prop is now deprecated. Use 'onAction' instead."),"onAction"in e||(e.onAction=e.action));const s=r.useNew(e),a=o??s,c={Button:S,Link:{onPress:u(()=>r.use().execute)},MenuItem:{onAction:u(()=>r.use().execute)},Modal:{slot:u(i=>{const{slot:f}=i,d=r.use();return d.needsConfirmation=f==="actionConfirm",f}),isDismissable:u(i=>{const d=r.use().state.useValue();return d==="isExecuting"||d==="isPending"?!1:i.isDismissable}),controller:u(()=>{const i=r.use();return i.needsConfirmation?i.confirmationModalController:i.getOverlayController("Modal")}),ActionGroup:{Button:S}}};return g.jsx(G,{value:a,children:g.jsx(N,{props:c,children:t})})},{type:"provider"});export{Z as A,r as a,b as s};

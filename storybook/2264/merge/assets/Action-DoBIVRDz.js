import{r as A,j as b}from"./iframe-CBKKDtut.js";import{u as k,O as M}from"./context-B4Ey35Kl.js";import{i as O}from"./browser-C9q5kf03.js";import{m as I,c as D,b as E,o as T,u as N,f as j,P as V}from"./flowComponent-D-Qq6Xd6.js";import{u as R,a as S}from"./useStatic-n8g6U0tI.js";import{A as $,g as G,u as F}from"./getActionGroupSlot-CKDi87pY.js";import{d as l}from"./dynamic-C3t3tmF9.js";const y=A.createContext(void 0),L=y.Provider,w=e=>new Promise(t=>setTimeout(t,e)),p={pending:1e3,succeeded:1500,failed:2e3};class g{showFeedback;state="isIdle";setPendingTimeout;error;isAsync=!1;constructor(){I(this,{state:T,updateState:E,isBusy:D})}static useNew(){return R(()=>new g)}updateState(t){this.state=t}useValue(){return S(()=>this.state,[this])}useIsBusy(){return S(()=>this.isBusy,[this])}get isBusy(){return this.state!=="isIdle"}onAsyncStart(){this.isAsync=!0,this.updateState("isExecuting"),this.setPendingTimeout=window.setTimeout(()=>this.startPending(),p.pending)}async onSucceeded(){await this.onDone()}async onFailed(t){this.error=t??new Error("Unknown error"),await this.onDone()}withFeedback(t){return this.showFeedback=t,this}async startFailedFeedback(){this.updateState("isFailed"),await w(p.failed),this.resetAfterDone()}async startSucceededFeedback(){this.updateState("isSucceeded"),await w(p.succeeded),this.resetAfterDone()}resetAfterDone(){this.updateState("isIdle"),this.isAsync=!1,this.error=void 0}async onDone(){this.setPendingTimeout&&window.clearTimeout(this.setPendingTimeout),this.error?await this.startFailedFeedback():this.showFeedback!==!1&&(this.showFeedback||this.isAsync)?await this.startSucceededFeedback():this.resetAfterDone()}startPending(){this.updateState("isPending")}}const B=e=>(...t)=>{const o=[...e],s=o.shift();if(s){const i=s(...t),a=()=>o.length===0?i:B(o)(...t);return i instanceof Promise?i.then(a):a()}},h=()=>{},U=(e,t={})=>{const{onSync:o=h,onAsync:s=h,then:i=h,catch:a=h,finally:c=h}=t;try{const n=e();return n instanceof Promise?(s(),n.then(i).catch(a).finally(c)):(o(),i(n),c(),n)}catch(n){o(),a(n),c()}},P=()=>{};function q(e){if(e.needsConfirmation)return e.confirmationModalController.open;const t=r=>typeof r=="string"?e.getOverlayController(r):r,{action:o,onAction:s=o,toggleOverlay:i,closeOverlay:a,openOverlay:c}=e.actionProps;return(s||(c?t(c)?.open:a?t(a)?.close:i?t(i)?.toggle:P))??P}class v{actions=[];baseAction;constructor(t){this.baseAction=t}addAction(t){this.actions.push(t)}async executeBatch(t){if(this.actions.length===0)return;const o=this.actions[this.actions.length-1]?.actionProps.showFeedback,s=this.baseAction.state.withFeedback(this.baseAction.needsConfirmation?!1:o),i=this.actions.map(n=>q(n)),a=B(i);let c;if(await U(()=>a(...t),{onAsync:()=>s.onAsyncStart(),then:()=>s.onSucceeded(),catch:n=>{s.onFailed(n),c=n}}),c)throw c}}class z{action;constructor(t){this.action=t}execute=(...t)=>{const o=this.getBatchedActions();(async()=>{for(const i of o)await i.executeBatch(t)})().catch(i=>console.error(i))};getBatchedActions=()=>{let t=this.action;const o=[];let s=new v(this.action),i=0;for(;t;){const{action:a,break:c,skip:n}=t.actionProps;if(t.needsConfirmation){s.addAction(t);break}if(n){i=n===!0?1:n,t=t.parentAction;continue}if(i>0){t=t.parentAction,i--;continue}if(c)break;a||(o.push(s),s=new v(this.action)),s.addAction(t),t=t.parentAction}return o.push(s),o}}class u{state;needsConfirmation;actionProps;parentAction;confirmationModalController;overlayContext;constructor(t){const{actionProps:o,needsConfirmation:s,parentAction:i,overlayContext:a,confirmationModalController:c,state:n}=t;this.actionProps=o,this.parentAction=i,this.confirmationModalController=c,this.needsConfirmation=s,this.overlayContext=a,this.state=n}static useNew(t,o={}){const s=A.useContext(y),i=k(),a=M.useNew(),c=g.useNew();return new u({parentAction:s,overlayContext:i,confirmationModalController:a,needsConfirmation:!1,actionProps:t,state:c,...o})}static use(){const t=A.useContext(y);return O(!!t,"Action context is not defined"),$.useRegisterState(t.state),t}static useConfirmationAction(){const t=u.use();return new u({actionProps:t.actionProps,confirmationModalController:t.confirmationModalController,overlayContext:t.overlayContext,state:t.state,needsConfirmation:!1,parentAction:u.useNew({closeOverlay:t.confirmationModalController},{parentAction:t.parentAction})})}getOverlayController(t){const o=s=>s===void 0?void 0:s?this.overlayContext[t]:void 0;return o(this.actionProps.openOverlay)??o(this.actionProps.closeOverlay)??o(this.actionProps.toggleOverlay)}execute=(...t)=>{new z(this).execute(...t)}}const H=e=>N()[e],x=e=>H("Modal")==="actionConfirm"?G(e):void 0,f=e=>{const t=u.use(),o=t.state.useValue(),s=x(e)==="primary",i=t.confirmationModalController.useIsOpen();return t.needsConfirmation&&i&&!s?"isIdle":o},m=()=>u.use().state.useValue(),C={onPress:l(e=>{const t=u.use(),o=u.useConfirmationAction(),s=x(e)==="primary";return x(e)==="abort"?t.confirmationModalController.close:s?o.execute:t.execute}),isPending:l(e=>{const t=f(e);return e.isPending??t==="isPending"}),isSucceeded:l(e=>{const t=f(e);return e.isSucceeded??t==="isSucceeded"}),isFailed:l(e=>{const t=f(e);return e.isFailed??t==="isFailed"}),"aria-disabled":l(e=>{const t=f(e),o=F().useIsBusy();return e["aria-disabled"]??(t==="isExecuting"||o)})},_=j("Action",e=>{const{children:t,actionModel:o,...s}=e,i=u.useNew(s),a=o??i,c={Button:C,SubmitButton:C,Link:{onPress:l(()=>u.use().execute)},MenuItem:{onAction:l(()=>u.use().execute),isPending:l(n=>{const r=m();return n.isPending??r==="isPending"}),isSucceeded:l(n=>{const r=m();return n.isSucceeded??r==="isSucceeded"}),isFailed:l(n=>{const r=m();return n.isFailed??r==="isFailed"}),isDisabled:l(n=>{const r=m(),d=F().useIsBusy();return n.isDisabled??(r==="isExecuting"||d)})},Modal:{slot:l(n=>{const{slot:r}=n,d=u.use();return d.needsConfirmation=r==="actionConfirm",r}),isDismissable:l(n=>{const d=u.use().state.useValue();return d==="isExecuting"||d==="isPending"?!1:n.isDismissable}),controller:l(()=>{const n=u.use();return n.needsConfirmation?n.confirmationModalController:n.getOverlayController("Modal")}),ActionGroup:{Button:C}}};return b.jsx(L,{value:a,children:b.jsx(V,{props:c,children:t})})},{type:"provider"});export{_ as A,u as a,w as s};

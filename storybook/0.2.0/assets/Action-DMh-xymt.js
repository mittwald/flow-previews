var M=Object.defineProperty;var O=(e,t,o)=>t in e?M(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;var c=(e,t,o)=>O(e,typeof t!="symbol"?t+"":t,o);import{j as b}from"./jsx-runtime-D_zvdyIk.js";import{r as A}from"./index-BZISi7jw.js";import{u as I,O as E}from"./context-DPIhxZmd.js";import{i as D}from"./browser-B1A6F7LW.js";import{m as N,c as T,a as j,o as R,u as V,f as $}from"./flowComponent-C3EXXnsB.js";import{u as G,a as v}from"./useStatic-CRo9aToR.js";import{a as L,g as U,u as q}from"./getActionGroupSlot-Bss6PZo0.js";import{P as z}from"./PropsContextProvider-CnD-oO9S.js";import{d}from"./dynamic-DKDa4OpU.js";const y=A.createContext(void 0),H=y.Provider,P=e=>new Promise(t=>setTimeout(t,e)),C={pending:1e3,succeeded:1500,failed:2e3};class g{constructor(){c(this,"showFeedback");c(this,"state","isIdle");c(this,"setPendingTimeout");c(this,"error");c(this,"isAsync",!1);N(this,{state:R,updateState:j,isBusy:T})}static useNew(){return G(()=>new g)}updateState(t){this.state=t}useValue(){return v(()=>this.state,[this])}useIsBusy(){return v(()=>this.isBusy,[this])}get isBusy(){return this.state!=="isIdle"}onAsyncStart(){this.isAsync=!0,this.updateState("isExecuting"),this.setPendingTimeout=window.setTimeout(()=>this.startPending(),C.pending)}async onSucceeded(){await this.onDone()}async onFailed(t){this.error=t??new Error("Unknown error"),await this.onDone()}withFeedback(t){return this.showFeedback=t,this}async startFailedFeedback(){this.updateState("isFailed"),await P(C.failed),this.resetAfterDone()}async startSucceededFeedback(){this.updateState("isSucceeded"),await P(C.succeeded),this.resetAfterDone()}resetAfterDone(){this.updateState("isIdle"),this.isAsync=!1,this.error=void 0}async onDone(){this.setPendingTimeout&&window.clearTimeout(this.setPendingTimeout),this.error?await this.startFailedFeedback():this.showFeedback!==!1&&(this.showFeedback||this.isAsync)?await this.startSucceededFeedback():this.resetAfterDone()}startPending(){this.updateState("isPending")}}const k=e=>(...t)=>{const o=[...e],n=o.shift();if(n){const s=n(...t),a=()=>o.length===0?s:k(o)(...t);return s instanceof Promise?s.then(a):a()}},f=()=>{},J=(e,t={})=>{const{onSync:o=f,onAsync:n=f,then:s=f,catch:a=f,finally:r=f}=t;try{const i=e();return i instanceof Promise?(n(),i.then(s).catch(a).finally(r)):(o(),s(i),r(),i)}catch(i){o(),a(i),r()}},S=()=>{};function K(e){var l,h,w;if(e.needsConfirmation)return e.confirmationModalController.open;const t=p=>typeof p=="string"?e.getOverlayController(p):p,{action:o,onAction:n=o,toggleOverlay:s,closeOverlay:a,openOverlay:r}=e.actionProps;return(n||(r?(l=t(r))==null?void 0:l.open:a?(h=t(a))==null?void 0:h.close:s?(w=t(s))==null?void 0:w.toggle:S))??S}class F{constructor(t){c(this,"actions",[]);c(this,"baseAction");this.baseAction=t}addAction(t){this.actions.push(t)}async executeBatch(t){var i;if(this.actions.length===0)return;const o=(i=this.actions[this.actions.length-1])==null?void 0:i.actionProps.showFeedback,n=this.baseAction.state.withFeedback(this.baseAction.needsConfirmation?!1:o),s=this.actions.map(l=>K(l)),a=k(s);let r;if(await J(()=>a(...t),{onAsync:()=>n.onAsyncStart(),then:()=>n.onSucceeded(),catch:l=>{n.onFailed(l),r=l}}),r)throw r}}class Q{constructor(t){c(this,"action");c(this,"execute",(...t)=>{const o=this.getBatchedActions();(async()=>{for(const s of o)await s.executeBatch(t)})().catch(s=>console.error(s))});c(this,"getBatchedActions",()=>{let t=this.action;const o=[];let n=new F(this.action),s=0;for(;t;){const{action:a,break:r,skip:i}=t.actionProps;if(t.needsConfirmation){n.addAction(t);break}if(i){s=i===!0?1:i,t=t.parentAction;continue}if(s>0){t=t.parentAction,s--;continue}if(r)break;a||(o.push(n),n=new F(this.action)),n.addAction(t),t=t.parentAction}return o.push(n),o});this.action=t}}class u{constructor(t){c(this,"state");c(this,"needsConfirmation");c(this,"actionProps");c(this,"parentAction");c(this,"confirmationModalController");c(this,"overlayContext");c(this,"execute",(...t)=>{new Q(this).execute(...t)});const{actionProps:o,needsConfirmation:n,parentAction:s,overlayContext:a,confirmationModalController:r,state:i}=t;this.actionProps=o,this.parentAction=s,this.confirmationModalController=r,this.needsConfirmation=n,this.overlayContext=a,this.state=i}static useNew(t,o={}){const n=A.useContext(y),s=I(),a=E.useNew(),r=g.useNew();return new u({parentAction:n,overlayContext:s,confirmationModalController:a,needsConfirmation:!1,actionProps:t,state:r,...o})}static use(){const t=A.useContext(y);return D(!!t,"Action context is not defined"),L.useRegisterState(t.state),t}static useConfirmationAction(){const t=u.use();return new u({actionProps:t.actionProps,confirmationModalController:t.confirmationModalController,overlayContext:t.overlayContext,state:t.state,needsConfirmation:!1,parentAction:u.useNew({closeOverlay:t.confirmationModalController},{parentAction:t.parentAction})})}getOverlayController(t){const o=n=>n===void 0?void 0:n?this.overlayContext[t]:void 0;return o(this.actionProps.openOverlay)??o(this.actionProps.closeOverlay)??o(this.actionProps.toggleOverlay)}}const W=e=>V()[e],x=e=>W("Modal")==="actionConfirm"?U(e):void 0,m=e=>{const t=u.use(),o=t.state.useValue(),n=x(e)==="primary",s=t.confirmationModalController.useIsOpen();return t.needsConfirmation&&s&&!n?"isIdle":o},B={onPress:d(e=>{const t=u.use(),o=u.useConfirmationAction(),n=x(e)==="primary";return x(e)==="abort"?t.confirmationModalController.close:n?o.execute:t.execute}),isPending:d(e=>m(e)==="isPending"),isSucceeded:d(e=>m(e)==="isSucceeded"),isFailed:d(e=>m(e)==="isFailed"),"aria-disabled":d(e=>{const t=m(e),o=q().useIsBusy();return t==="isExecuting"||o})},X=$("Action",e=>{const{children:t,actionModel:o,...n}=e,s=u.useNew(n),a=o??s,r={Button:B,Link:{onPress:d(()=>u.use().execute)},MenuItem:{onAction:d(()=>u.use().execute)},Modal:{slot:d(i=>{const{slot:l}=i,h=u.use();return h.needsConfirmation=l==="actionConfirm",l}),isDismissable:d(i=>{const h=u.use().state.useValue();return h==="isExecuting"||h==="isPending"?!1:i.isDismissable}),controller:d(()=>{const i=u.use();return i.needsConfirmation?i.confirmationModalController:i.getOverlayController("Modal")}),ActionGroup:{Button:B}}};return b.jsx(H,{value:a,children:b.jsx(z,{props:r,mergeInParentContext:!0,children:t})})});X.__docgenInfo={description:"",methods:[],displayName:"Action"};export{X as A,u as a,P as s};

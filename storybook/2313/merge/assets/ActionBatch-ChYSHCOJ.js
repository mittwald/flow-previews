import{r as p,j as A}from"./iframe-HxmydubW.js";import{u as F,O as k}from"./context-I_ID-Cd_.js";import{i as M}from"./browser-XpDtWA4a.js";import{m as O,c as I,b as E,o as T,u as D,f as N,P as j}from"./flowComponent-DGGyXaO_.js";import{u as V,a as b}from"./useStatic-ffXkYFOn.js";import{A as G,g as R,u as B}from"./getActionGroupSlot-CHtGBuk8.js";import{d as u}from"./dynamic-D7w-3Mi4.js";const C=p.createContext(void 0),U=C.Provider,P=e=>new Promise(t=>setTimeout(t,e)),m={pending:1e3,succeeded:1500,failed:2e3};class x{showFeedback;state="isIdle";setPendingTimeout;error;isAsync=!1;constructor(){O(this,{state:T,updateState:E,isBusy:I})}static useNew(){return V(()=>new x)}updateState(t){this.state=t}useValue(){return b(()=>this.state,[this])}useIsBusy(){return b(()=>this.isBusy,[this])}get isBusy(){return this.state!=="isIdle"}onAsyncStart(){this.clearPendingTimeout(),this.isAsync=!0,this.updateState("isExecuting"),this.setPendingTimeout=window.setTimeout(()=>this.startPending(),m.pending)}async onSucceeded(){await this.onDone()}async onFailed(t){this.error=t??new Error("Unknown error"),await this.onDone()}withFeedback(t){return this.showFeedback=t,this}async startFailedFeedback(){this.updateState("isFailed"),await P(m.failed),this.resetAfterDone()}async startSucceededFeedback(){this.updateState("isSucceeded"),await P(m.succeeded),this.resetAfterDone()}resetAfterDone(){this.updateState("isIdle"),this.isAsync=!1,this.error=void 0}clearPendingTimeout(){this.setPendingTimeout&&window.clearTimeout(this.setPendingTimeout)}onDone(){if(this.clearPendingTimeout(),this.error)return this.startFailedFeedback();if(this.showFeedback!==!1&&(this.showFeedback||this.isAsync))return this.startSucceededFeedback();this.resetAfterDone()}startPending(){this.updateState("isPending")}}const g=e=>(...t)=>{const o=[...e],n=o.shift();if(n){const i=n(...t),c=()=>o.length===0?i:g(o)(...t);return i instanceof Promise?i.then(c):c()}},S=()=>{};function L(e){if(e.needsConfirmation)return e.confirmationModalController.open;const t=s=>typeof s=="string"?e.getOverlayController(s):s,{onAction:o,toggleOverlay:n,closeOverlay:i,openOverlay:c}=e.actionProps;return(o||(c?t(c)?.open:i?t(i)?.close:n?t(n)?.toggle:S))??S}class w{actions=[];baseAction;constructor(t){this.baseAction=t}addAction(t){this.actions.push(t)}executeBatch(...t){if(this.actions.length===0)return;const o=this.actions[this.actions.length-1]?.actionProps.showFeedback,n=this.baseAction.state.withFeedback(this.baseAction.needsConfirmation?!1:o),i=this.actions.map(a=>L(a)),c=g(i),d=a=>{throw n.onFailed(a),a},s=()=>n.onSucceeded();try{const a=c(...t);return a instanceof Promise?(n.onAsyncStart(),a.then(s).catch(d)):(s(),a)}catch(a){d(a)}}}class ${action;constructor(t){this.action=t}execute=(...t)=>{const o=this.getBatchedActions();g(o.map(i=>i.executeBatch.bind(i)))(...t)};getBatchedActions=()=>{let t=this.action;const o=[];let n=new w(this.action),i=0;for(;t;){const{onAction:c,break:d,skip:s}=t.actionProps;if(t.needsConfirmation){n.addAction(t);break}if(s){i=s===!0?1:s,t=t.parentAction;continue}if(i>0){t=t.parentAction,i--;continue}if(d)break;c||(o.push(n),n=new w(this.action)),n.addAction(t),t=t.parentAction}return o.push(n),o}}class r{state;needsConfirmation;actionProps;parentAction;confirmationModalController;overlayContext;constructor(t){const{actionProps:o,needsConfirmation:n,parentAction:i,overlayContext:c,confirmationModalController:d,state:s}=t;this.actionProps=o,this.parentAction=i,this.confirmationModalController=d,this.needsConfirmation=n,this.overlayContext=c,this.state=s}static useNew(t,o={}){const n=p.useContext(C),i=F(),c=k.useNew(),d=x.useNew();return new r({parentAction:n,overlayContext:i,confirmationModalController:c,needsConfirmation:!1,actionProps:t,state:d,...o})}static use(){const t=p.useContext(C);return M(!!t,"Action context is not defined"),G.useRegisterState(t.state),t}static useConfirmationAction(){const t=r.use();return new r({actionProps:t.actionProps,confirmationModalController:t.confirmationModalController,overlayContext:t.overlayContext,state:t.state,needsConfirmation:!1,parentAction:r.useNew({closeOverlay:t.confirmationModalController},{parentAction:t.parentAction})})}getOverlayController(t){const o=n=>n===void 0?void 0:n?this.overlayContext[t]:void 0;return o(this.actionProps.openOverlay)??o(this.actionProps.closeOverlay)??o(this.actionProps.toggleOverlay)}execute=(...t)=>{new $(this).execute(...t)}}const q=e=>D()[e],y=e=>q("Modal")==="actionConfirm"?R(e):void 0,h=e=>{const t=r.use(),o=t.state.useValue(),n=y(e)==="primary",i=t.confirmationModalController.useIsOpen();return t.needsConfirmation&&i&&!n?"isIdle":o},f=()=>r.use().state.useValue(),v={onPress:u(e=>{const t=r.use(),o=r.useConfirmationAction(),n=y(e)==="primary";return y(e)==="abort"?t.confirmationModalController.close:n?o.execute:t.execute}),isPending:u(e=>{const t=h(e);return e.isPending??t==="isPending"}),isSucceeded:u(e=>{const t=h(e);return e.isSucceeded??t==="isSucceeded"}),isFailed:u(e=>{const t=h(e);return e.isFailed??t==="isFailed"}),"aria-disabled":u(e=>{const t=h(e),o=B().useIsBusy();return e["aria-disabled"]??(t==="isExecuting"||o)})},z=N("Action",e=>{const{children:t,actionModel:o,...n}=e;"action"in n&&typeof n.action=="function"&&(console.warn("The 'action' prop is now deprecated. Use 'onAction' instead."),"onAction"in n||(n.onAction=n.action));const i=r.useNew(n),c=o??i,d={Button:v,Link:{onPress:u(()=>r.use().execute)},MenuItem:{onAction:u(()=>r.use().execute),isPending:u(s=>{const a=f();return s.isPending??a==="isPending"}),isSucceeded:u(s=>{const a=f();return s.isSucceeded??a==="isSucceeded"}),isFailed:u(s=>{const a=f();return s.isFailed??a==="isFailed"}),"aria-disabled":u(s=>{const a=f(),l=B().useIsBusy();return s["aria-disabled"]??(a==="isExecuting"||l)})},Modal:{slot:u(s=>{const{slot:a}=s,l=r.use();return l.needsConfirmation=a==="actionConfirm",a}),isDismissable:u(s=>{const l=r.use().state.useValue();return l==="isExecuting"||l==="isPending"?!1:s.isDismissable}),controller:u(()=>{const s=r.use();return s.needsConfirmation?s.confirmationModalController:s.getOverlayController("Modal")}),ActionGroup:{Button:v}}};return A.jsx(U,{value:c,children:A.jsx(j,{props:d,children:t})})},{type:"provider"}),H=e=>{const{children:t}=e;return A.jsx(z,{children:t})};H.__docgenInfo={description:`Batches multiple actions together and shows feedback when all actions have
completed.

By default async actions are automatically batched.`,methods:[],displayName:"ActionBatch"};export{z as A,r as a,H as b,P as s};

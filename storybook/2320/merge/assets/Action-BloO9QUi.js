import{r as C,j as P}from"./iframe-BRGIT6aC.js";import{u as O,O as v}from"./context-Dnnfbmmg.js";import{m as k,c as I,b as E,o as T,u as D,f as N,P as j}from"./flowComponent-gC5J80sd.js";import{i as V}from"./browser-BYxlW31W.js";import{u as R,a as S}from"./useStatic-3STTURCL.js";import{d as u}from"./dynamic-DJEA9S0A.js";import{A as G,g as U,u as B}from"./getActionGroupSlot-C3tMCkBR.js";const A=C.createContext(void 0),L=A.Provider,b=e=>new Promise(t=>setTimeout(t,e)),p={pending:1e3,succeeded:1500,failed:2e3};class y{showFeedback;state="isIdle";setPendingTimeout;error;isAsync=!1;constructor(){k(this,{state:T,updateState:E,isBusy:I})}static useNew(){return R(()=>new y)}updateState(t){this.state=t}useValue(){return S(()=>this.state,[this])}useIsBusy(){return S(()=>this.isBusy,[this])}get isBusy(){return this.state!=="isIdle"}onAsyncStart(){this.clearPendingTimeout(),this.isAsync=!0,this.updateState("isExecuting"),this.setPendingTimeout=window.setTimeout(()=>this.startPending(),p.pending)}async onSucceeded(){await this.onDone()}async onFailed(t){this.error=t??new Error("Unknown error"),await this.onDone()}withFeedback(t){return this.showFeedback=t,this}async startFailedFeedback(){this.updateState("isFailed"),await b(p.failed),this.resetAfterDone()}async startSucceededFeedback(){this.updateState("isSucceeded"),await b(p.succeeded),this.resetAfterDone()}resetAfterDone(){this.updateState("isIdle"),this.isAsync=!1,this.error=void 0}clearPendingTimeout(){this.setPendingTimeout&&window.clearTimeout(this.setPendingTimeout)}onDone(){if(this.clearPendingTimeout(),this.error)return this.startFailedFeedback();if(this.showFeedback!==!1&&(this.showFeedback||this.isAsync))return this.startSucceededFeedback();this.resetAfterDone()}startPending(){this.updateState("isPending")}}const x=e=>(...t)=>{const n=[...e],o=n.shift();if(o){const s=o(...t),a=()=>n.length===0?s:x(n)(...t);return s instanceof Promise?s.then(a):a()}},w=()=>{};function $(e){if(e.needsConfirmation)return e.confirmationModalController.open;const{onAction:t,toggleOverlay:n,closeOverlay:o,openOverlay:s,openModal:a,closeModal:l,toggleModal:i}=e.actionProps;return(t||(s?()=>e.getOverlayController(s)?.open():o?()=>e.getOverlayController(o)?.close():n?()=>e.getOverlayController(n)?.toggle():a?()=>e.getOverlayController("Modal")?.open():i?()=>e.getOverlayController("Modal")?.toggle():l?()=>e.getOverlayController("Modal")?.close():w))??w}class M{actions=[];baseAction;constructor(t){this.baseAction=t}addAction(t){this.actions.push(t)}executeBatch(...t){if(this.actions.length===0)return;const n=this.actions[this.actions.length-1]?.actionProps.showFeedback,o=this.baseAction.state.withFeedback(this.baseAction.needsConfirmation?!1:n),s=this.actions.map(r=>$(r)),a=x(s),l=r=>{throw o.onFailed(r),r},i=()=>o.onSucceeded();try{const r=a(...t);if(r instanceof Promise)return o.onAsyncStart(),r.then(i).catch(l);{const d=i();return d instanceof Promise?d.then(()=>r):r}}catch(r){l(r)}}}class h extends Error{constructor(t){super(t),this.name="MutedActionError"}static isMutedActionError(t){return t instanceof h}static rethrowIfNotMuted(t){if(!h.isMutedActionError(t))throw t}}class q{action;constructor(t){this.action=t}execute=(...t)=>{const n=this.getBatchedActions(),o=x(n.map(s=>s.executeBatch.bind(s)));try{const s=o(...t);s instanceof Promise&&s.catch(a=>{h.rethrowIfNotMuted(a)})}catch(s){h.rethrowIfNotMuted(s)}};getBatchedActions=()=>{let t=this.action;const n=[];let o=new M(this.action),s=0;for(;t;){const{onAction:a,break:l,skip:i}=t.actionProps;if(t.needsConfirmation){o.addAction(t);break}if(i){s=i===!0?1:i,t=t.parentAction;continue}if(s>0){t=t.parentAction,s--;continue}if(l)break;a||(n.push(o),o=new M(this.action)),o.addAction(t),t=t.parentAction}return n.push(o),n}}class c{state;needsConfirmation;actionProps;parentAction;confirmationModalController;overlayContext;constructor(t){const{actionProps:n,needsConfirmation:o,parentAction:s,overlayContext:a,confirmationModalController:l,state:i}=t;this.actionProps=n,this.parentAction=s,this.confirmationModalController=l,this.needsConfirmation=o,this.overlayContext=a,this.state=i}static useNew(t,n={}){const o=C.useContext(A),s=O(),a=v.useNew(),l=y.useNew();return new c({parentAction:o,overlayContext:s,confirmationModalController:a,needsConfirmation:!1,actionProps:t,state:l,...n})}static use(){const t=C.useContext(A);return V(!!t,"Action context is not defined"),G.useRegisterState(t.state),t}static useConfirmationAction(){const t=c.use();return new c({actionProps:t.actionProps,confirmationModalController:t.confirmationModalController,overlayContext:t.overlayContext,state:t.state,needsConfirmation:!1,parentAction:c.useNew({closeOverlay:t.confirmationModalController},{parentAction:t.parentAction})})}getOverlayController(t){const n=o=>{if(o!==void 0){if(t instanceof v)return t;if(typeof t=="string")return this.overlayContext[t]}};return n(this.actionProps.openOverlay)??n(this.actionProps.closeOverlay)??n(this.actionProps.toggleOverlay)??n(this.actionProps.openModal?"Modal":void 0)??n(this.actionProps.closeModal?"Modal":void 0)??n(this.actionProps.toggleModal?"Modal":void 0)}execute=(...t)=>{new q(this).execute(...t)}}const z=e=>D()[e],g=e=>z("Modal")==="actionConfirm"?U(e):void 0,f=e=>{const t=c.use(),n=t.state.useValue(),o=g(e)==="primary",s=t.confirmationModalController.useIsOpen();return t.needsConfirmation&&s&&!o?"isIdle":n},m=()=>c.use().state.useValue(),F={onPress:u(e=>{const t=c.use(),n=c.useConfirmationAction(),o=g(e)==="primary";return g(e)==="abort"?t.confirmationModalController.close:o?n.execute:t.execute}),isPending:u(e=>{const t=f(e);return e.isPending??t==="isPending"}),isSucceeded:u(e=>{const t=f(e);return e.isSucceeded??t==="isSucceeded"}),isFailed:u(e=>{const t=f(e);return e.isFailed??t==="isFailed"}),"aria-disabled":u(e=>{const t=f(e),n=B().useIsBusy();return e["aria-disabled"]??(t==="isExecuting"||n)})},Z=N("Action",e=>{const{children:t,actionModel:n,...o}=e;"action"in o&&typeof o.action=="function"&&(console.warn("The 'action' prop is now deprecated. Use 'onAction' instead."),"onAction"in o||(o.onAction=o.action));const s=c.useNew(o),a=n??s,l={Button:F,Link:{onPress:u(()=>c.use().execute)},MenuItem:{onAction:u(()=>c.use().execute),isPending:u(i=>{const r=m();return i.isPending??r==="isPending"}),isSucceeded:u(i=>{const r=m();return i.isSucceeded??r==="isSucceeded"}),isFailed:u(i=>{const r=m();return i.isFailed??r==="isFailed"}),"aria-disabled":u(i=>{const r=m(),d=B().useIsBusy();return i["aria-disabled"]??(r==="isExecuting"||d)})},Modal:{slot:u(i=>{const{slot:r}=i,d=c.use();return d.needsConfirmation=r==="actionConfirm",r}),isDismissable:u(i=>{const d=c.use().state.useValue();return d==="isExecuting"||d==="isPending"?!1:i.isDismissable}),controller:u(()=>{const i=c.use();return i.needsConfirmation?i.confirmationModalController:i.getOverlayController("Modal")}),ActionGroup:{Button:F}}};return P.jsx(L,{value:a,children:P.jsx(j,{props:l,children:t})})},{type:"provider"});export{Z as A,c as a,b as s};

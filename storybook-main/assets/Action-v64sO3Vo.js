var D=Object.defineProperty;var q=(n,t,e)=>t in n?D(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var r=(n,t,e)=>q(n,typeof t!="symbol"?t+"":t,e);import{r as d,R as A}from"./index-uCp2LrAq.js";import{u as R,O as V}from"./context-FRXDLkOm.js";import{i as $}from"./Text-CadoLc4y.js";import{m as O,o as M,b as v,c as T,u as G}from"./flowComponent-S8oBNLtu.js";import{u as g}from"./useSelector-O6pPILhT.js";import{P as L}from"./PropsContextProvider-RdMO5ekw.js";import{d as u}from"./dynamic-DKDa4OpU.js";class f{constructor(){r(this,"states",new Set);O(this,{states:M,addState:v,removeState:v,isBusy:T})}static useNew(){return d.useRef(new f).current}static useRegisterState(t){const e=N();d.useEffect(()=>(e==null||e.addState(t),()=>{e==null||e.removeState(t)}),[e,t])}addState(t){this.states.add(t)}removeState(t){this.states.delete(t)}useIsBusy(){return g(()=>this.isBusy)}get isBusy(){for(const t of this.states)if(t.isBusy)return!0;return!1}}const I=d.createContext(void 0),U=n=>{const{children:t}=n,e=f.useNew();return A.createElement(I.Provider,{value:e},t)},N=()=>{const n=f.useNew();return d.useContext(I)??n};U.__docgenInfo={description:"",methods:[],displayName:"ActionStateContextProvider"};const W=n=>{const{slot:t,...e}=n,o=e.color===void 0||e.color==="primary"||e.color==="danger"||e.color==="accent"?"primary":"abort";return t??o},b=d.createContext(void 0),j=b.Provider,S=n=>new Promise(t=>setTimeout(t,n)),w={pending:1e3,succeeded:1500,failed:2e3};class P{constructor(){r(this,"showFeedback");r(this,"state","isIdle");r(this,"setPendingTimeout");r(this,"error");r(this,"isAsync",!1);O(this,{state:M,updateState:v,isBusy:T})}static useNew(){return d.useRef(new P).current}updateState(t){this.state=t}useValue(){return g(()=>this.state,[this])}useIsBusy(){return g(()=>this.isBusy,[this])}get isBusy(){return this.state!=="isIdle"}onAsyncStart(){this.isAsync=!0,this.updateState("isExecuting"),this.setPendingTimeout=window.setTimeout(()=>this.startPending(),w.pending)}async onSucceeded(){await this.onDone()}async onFailed(t){this.error=t??new Error("Unknown error"),await this.onDone()}withFeedback(t){return this.showFeedback=t,this}async startFailedFeedback(){this.updateState("isFailed"),await S(w.failed),this.resetAfterDone()}async startSucceededFeedback(){this.updateState("isSucceeded"),await S(w.succeeded),this.resetAfterDone()}resetAfterDone(){this.updateState("isIdle"),this.isAsync=!1,this.error=void 0}async onDone(){this.setPendingTimeout&&window.clearTimeout(this.setPendingTimeout),this.error?await this.startFailedFeedback():this.showFeedback!==!1&&(this.showFeedback||this.isAsync)?await this.startSucceededFeedback():this.resetAfterDone()}startPending(){this.updateState("isPending")}}const E=n=>(...t)=>{const e=[...n],o=e.shift();if(o){const s=o(...t),a=()=>e.length===0?s:E(e)(...t);return s instanceof Promise?s.then(a):a()}},p=()=>{},z=(n,t={})=>{const{onSync:e=p,onAsync:o=p,then:s=p,catch:a=p,finally:c=p}=t;try{const i=n();return i instanceof Promise?(o(),i.then(s).catch(a).finally(c)):(e(),s(i),c(),i)}catch(i){e(),a(i),c()}},F=()=>{};function H(n){var i,h,m;if(n.needsConfirmation)return n.confirmationModalController.open;const t=C=>typeof C=="string"?n.getOverlayController(C):C,{action:e,toggleOverlay:o,closeOverlay:s,openOverlay:a}=n.actionProps;return(e||(a?(i=t(a))==null?void 0:i.open:s?(h=t(s))==null?void 0:h.close:o?(m=t(o))==null?void 0:m.toggle:F))??F}class k{constructor(t){r(this,"actions",[]);r(this,"baseAction");this.baseAction=t}addAction(t){this.actions.push(t)}async executeBatch(t){if(this.actions.length===0)return;const e=this.actions[this.actions.length-1].actionProps.showFeedback,o=this.baseAction.state.withFeedback(this.baseAction.needsConfirmation?!1:e),s=this.actions.map(i=>H(i)),a=E(s);let c;if(await z(()=>a(...t),{onAsync:()=>o.onAsyncStart(),then:()=>o.onSucceeded(),catch:i=>{o.onFailed(i),c=i}}),c)throw c}}class J{constructor(t){r(this,"action");r(this,"execute",(...t)=>{const e=this.getBatchedActions();(async()=>{for(const s of e)await s.executeBatch(t)})().catch(s=>console.error(s))});r(this,"getBatchedActions",()=>{let t=this.action;const e=[];let o=new k(this.action),s=0;for(;t;){const{action:a,break:c,skip:i}=t.actionProps;if(t.needsConfirmation){o.addAction(t);break}if(i){s=i===!0?1:i,t=t.parentAction;continue}if(s>0){t=t.parentAction,s--;continue}if(c)break;a||(e.push(o),o=new k(this.action)),o.addAction(t),t=t.parentAction}return e.push(o),e});this.action=t}}class l{constructor(t){r(this,"state");r(this,"needsConfirmation");r(this,"actionProps");r(this,"parentAction");r(this,"confirmationModalController");r(this,"overlayContext");r(this,"execute",(...t)=>{new J(this).execute(...t)});const{actionProps:e,needsConfirmation:o,parentAction:s,overlayContext:a,confirmationModalController:c,state:i}=t;this.actionProps=e,this.parentAction=s,this.confirmationModalController=c,this.needsConfirmation=o,this.overlayContext=a,this.state=i}static useNew(t,e={}){const o=d.useContext(b),s=R(),a=V.useNew(),c=P.useNew();return new l({parentAction:o,overlayContext:s,confirmationModalController:a,needsConfirmation:!1,actionProps:t,state:c,...e})}static use(){const t=d.useContext(b);return $(!!t,"Action context is not defined"),f.useRegisterState(t.state),t}static useConfirmationAction(){const t=l.use();return new l({actionProps:t.actionProps,confirmationModalController:t.confirmationModalController,overlayContext:t.overlayContext,state:t.state,needsConfirmation:!1,parentAction:l.useNew({closeOverlay:t.confirmationModalController},{parentAction:t.parentAction})})}getOverlayController(t){const e=o=>o===void 0?void 0:o?this.overlayContext[t]:void 0;return e(this.actionProps.openOverlay)??e(this.actionProps.closeOverlay)??e(this.actionProps.toggleOverlay)}}const K=n=>G()[n],x=n=>K("Modal")==="actionConfirm"?W(n):void 0,y=n=>{const t=l.use(),e=t.state.useValue(),o=x(n)==="primary",s=t.confirmationModalController.useIsOpen();return t.needsConfirmation&&s&&!o?"isIdle":e},B={onPress:u(n=>{const t=l.use(),e=l.useConfirmationAction(),o=x(n)==="primary";return x(n)==="abort"?t.confirmationModalController.close:o?e.execute:t.execute}),isPending:u(n=>y(n)==="isPending"),isSucceeded:u(n=>y(n)==="isSucceeded"),isFailed:u(n=>y(n)==="isFailed"),"aria-disabled":u(n=>{const t=y(n),e=N().useIsBusy();return t==="isExecuting"||e})},Q=n=>{const{children:t,actionModel:e,...o}=n,s=l.useNew(o),a=e??s,c={Button:B,Link:{onPress:u(()=>l.use().execute)},MenuItem:{onAction:u(()=>l.use().execute)},Modal:{slot:u(i=>{const{slot:h}=i,m=l.use();return m.needsConfirmation=h==="actionConfirm",h}),isDismissable:u(i=>{const m=l.use().state.useValue();return m==="isExecuting"||m==="isPending"?!1:i.isDismissable}),controller:u(()=>{const i=l.use();return i.needsConfirmation?i.confirmationModalController:i.getOverlayController("Modal")}),ActionGroup:{Button:B}}};return A.createElement(j,{value:a},A.createElement(L,{props:c,mergeInParentContext:!0},t))};Q.__docgenInfo={description:"",methods:[],displayName:"Action",props:{action:{required:!1,tsType:{name:"signature",type:"function",raw:"(...args: unknown[]) => unknown",signature:{arguments:[{type:{name:"Array",elements:[{name:"unknown"}],raw:"unknown[]"},name:"args",rest:!0}],return:{name:"unknown"}}},description:""},actionModel:{required:!1,tsType:{name:"ActionModel"},description:""},closeOverlay:{required:!1,tsType:{name:"union",raw:"FlowComponentName | OverlayController",elements:[{name:"FlowComponentPropsTypes"},{name:"OverlayController"}]},description:""},openOverlay:{required:!1,tsType:{name:"union",raw:"FlowComponentName | OverlayController",elements:[{name:"FlowComponentPropsTypes"},{name:"OverlayController"}]},description:""},toggleOverlay:{required:!1,tsType:{name:"union",raw:"FlowComponentName | OverlayController",elements:[{name:"FlowComponentPropsTypes"},{name:"OverlayController"}]},description:""},break:{required:!1,tsType:{name:"boolean"},description:""},skip:{required:!1,tsType:{name:"union",raw:"number | boolean",elements:[{name:"number"},{name:"boolean"}]},description:""},showFeedback:{required:!1,tsType:{name:"boolean"},description:""}},composes:["PropsWithChildren"]};export{Q as A,U as a,l as b,W as g,S as s};

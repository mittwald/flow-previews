var k=Object.defineProperty;var M=(n,t,e)=>t in n?k(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var c=(n,t,e)=>M(n,typeof t!="symbol"?t+"":t,e);import{r as A,R as w}from"./index-B-o1Wr-g.js";import{u as O,O as I}from"./context-tra5QY3B.js";import{i as E}from"./browser-B3hGj0u-.js";import{m as D,o as N,a as T,c as R,u as V,f as $,P as G}from"./flowComponent-Bi8R7MU8.js";import{u as L,a as b}from"./useStatic-DVVlOpvb.js";import{a as U,g as j,u as q}from"./getActionGroupSlot-7U_pQ_UO.js";import{d as l}from"./dynamic-DKDa4OpU.js";const y=A.createContext(void 0),z=y.Provider,v=n=>new Promise(t=>setTimeout(t,n)),C={pending:1e3,succeeded:1500,failed:2e3};class g{constructor(){c(this,"showFeedback");c(this,"state","isIdle");c(this,"setPendingTimeout");c(this,"error");c(this,"isAsync",!1);D(this,{state:N,updateState:T,isBusy:R})}static useNew(){return L(()=>new g)}updateState(t){this.state=t}useValue(){return b(()=>this.state,[this])}useIsBusy(){return b(()=>this.isBusy,[this])}get isBusy(){return this.state!=="isIdle"}onAsyncStart(){this.isAsync=!0,this.updateState("isExecuting"),this.setPendingTimeout=window.setTimeout(()=>this.startPending(),C.pending)}async onSucceeded(){await this.onDone()}async onFailed(t){this.error=t??new Error("Unknown error"),await this.onDone()}withFeedback(t){return this.showFeedback=t,this}async startFailedFeedback(){this.updateState("isFailed"),await v(C.failed),this.resetAfterDone()}async startSucceededFeedback(){this.updateState("isSucceeded"),await v(C.succeeded),this.resetAfterDone()}resetAfterDone(){this.updateState("isIdle"),this.isAsync=!1,this.error=void 0}async onDone(){this.setPendingTimeout&&window.clearTimeout(this.setPendingTimeout),this.error?await this.startFailedFeedback():this.showFeedback!==!1&&(this.showFeedback||this.isAsync)?await this.startSucceededFeedback():this.resetAfterDone()}startPending(){this.updateState("isPending")}}const B=n=>(...t)=>{const e=[...n],o=e.shift();if(o){const s=o(...t),a=()=>e.length===0?s:B(e)(...t);return s instanceof Promise?s.then(a):a()}},f=()=>{},H=(n,t={})=>{const{onSync:e=f,onAsync:o=f,then:s=f,catch:a=f,finally:r=f}=t;try{const i=n();return i instanceof Promise?(o(),i.then(s).catch(a).finally(r)):(e(),s(i),r(),i)}catch(i){e(),a(i),r()}},P=()=>{};function J(n){var i,h,d;if(n.needsConfirmation)return n.confirmationModalController.open;const t=p=>typeof p=="string"?n.getOverlayController(p):p,{action:e,toggleOverlay:o,closeOverlay:s,openOverlay:a}=n.actionProps;return(e||(a?(i=t(a))==null?void 0:i.open:s?(h=t(s))==null?void 0:h.close:o?(d=t(o))==null?void 0:d.toggle:P))??P}class S{constructor(t){c(this,"actions",[]);c(this,"baseAction");this.baseAction=t}addAction(t){this.actions.push(t)}async executeBatch(t){if(this.actions.length===0)return;const e=this.actions[this.actions.length-1].actionProps.showFeedback,o=this.baseAction.state.withFeedback(this.baseAction.needsConfirmation?!1:e),s=this.actions.map(i=>J(i)),a=B(s);let r;if(await H(()=>a(...t),{onAsync:()=>o.onAsyncStart(),then:()=>o.onSucceeded(),catch:i=>{o.onFailed(i),r=i}}),r)throw r}}class K{constructor(t){c(this,"action");c(this,"execute",(...t)=>{const e=this.getBatchedActions();(async()=>{for(const s of e)await s.executeBatch(t)})().catch(s=>console.error(s))});c(this,"getBatchedActions",()=>{let t=this.action;const e=[];let o=new S(this.action),s=0;for(;t;){const{action:a,break:r,skip:i}=t.actionProps;if(t.needsConfirmation){o.addAction(t);break}if(i){s=i===!0?1:i,t=t.parentAction;continue}if(s>0){t=t.parentAction,s--;continue}if(r)break;a||(e.push(o),o=new S(this.action)),o.addAction(t),t=t.parentAction}return e.push(o),e});this.action=t}}class u{constructor(t){c(this,"state");c(this,"needsConfirmation");c(this,"actionProps");c(this,"parentAction");c(this,"confirmationModalController");c(this,"overlayContext");c(this,"execute",(...t)=>{new K(this).execute(...t)});const{actionProps:e,needsConfirmation:o,parentAction:s,overlayContext:a,confirmationModalController:r,state:i}=t;this.actionProps=e,this.parentAction=s,this.confirmationModalController=r,this.needsConfirmation=o,this.overlayContext=a,this.state=i}static useNew(t,e={}){const o=A.useContext(y),s=O(),a=I.useNew(),r=g.useNew();return new u({parentAction:o,overlayContext:s,confirmationModalController:a,needsConfirmation:!1,actionProps:t,state:r,...e})}static use(){const t=A.useContext(y);return E(!!t,"Action context is not defined"),U.useRegisterState(t.state),t}static useConfirmationAction(){const t=u.use();return new u({actionProps:t.actionProps,confirmationModalController:t.confirmationModalController,overlayContext:t.overlayContext,state:t.state,needsConfirmation:!1,parentAction:u.useNew({closeOverlay:t.confirmationModalController},{parentAction:t.parentAction})})}getOverlayController(t){const e=o=>o===void 0?void 0:o?this.overlayContext[t]:void 0;return e(this.actionProps.openOverlay)??e(this.actionProps.closeOverlay)??e(this.actionProps.toggleOverlay)}}const Q=n=>V()[n],x=n=>Q("Modal")==="actionConfirm"?j(n):void 0,m=n=>{const t=u.use(),e=t.state.useValue(),o=x(n)==="primary",s=t.confirmationModalController.useIsOpen();return t.needsConfirmation&&s&&!o?"isIdle":e},F={onPress:l(n=>{const t=u.use(),e=u.useConfirmationAction(),o=x(n)==="primary";return x(n)==="abort"?t.confirmationModalController.close:o?e.execute:t.execute}),isPending:l(n=>m(n)==="isPending"),isSucceeded:l(n=>m(n)==="isSucceeded"),isFailed:l(n=>m(n)==="isFailed"),"aria-disabled":l(n=>{const t=m(n),e=q().useIsBusy();return t==="isExecuting"||e})},W=$("Action",n=>{const{children:t,actionModel:e,...o}=n,s=u.useNew(o),a=e??s,r={Button:F,Link:{onPress:l(()=>u.use().execute)},MenuItem:{onAction:l(()=>u.use().execute)},Modal:{slot:l(i=>{const{slot:h}=i,d=u.use();return d.needsConfirmation=h==="actionConfirm",h}),isDismissable:l(i=>{const d=u.use().state.useValue();return d==="isExecuting"||d==="isPending"?!1:i.isDismissable}),controller:l(()=>{const i=u.use();return i.needsConfirmation?i.confirmationModalController:i.getOverlayController("Modal")}),ActionGroup:{Button:F}}};return w.createElement(z,{value:a},w.createElement(G,{props:r,mergeInParentContext:!0},t))});W.__docgenInfo={description:"",methods:[],displayName:"Action"};export{W as A,u as a,v as s};

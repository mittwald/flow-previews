var V=Object.defineProperty;var W=(n,e,t)=>e in n?V(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var a=(n,e,t)=>(W(n,typeof e!="symbol"?e+"":e,t),t);import{r as u,R as i}from"./index-uCp2LrAq.js";import{a as $,m as w,o as g,b as m,c as P}from"./flowComponent-BXgpTJfi.js";import{i as L}from"./Text-Cxmp4Xqy.js";import{P as f}from"./PropsContextProvider-v92cY4my.js";import{W as F}from"./Wrap-DQq6jo70.js";const I=u.createContext(void 0),ee=I.Provider,y=(n,e=[])=>{const[t,o]=u.useState(n());return u.useEffect(()=>$(()=>{o(n())}),e),t};class b{constructor(e=!1){a(this,"isOpen");w(this,{isOpen:g,open:m.bound,close:m.bound,toggle:m.bound,setOpen:m.bound}),this.isOpen=e}static useNew(e){return u.useRef(new b(e)).current}open(){this.isOpen=!0}close(){this.isOpen=!1}toggle(){this.isOpen=!this.isOpen}setOpen(e){this.isOpen=e}useIsOpen(){return y(()=>this.isOpen)}}const E=(n={})=>{const{reuseControllerFromContext:e=!0,defaultOpen:t}=n,o=b.useNew(t),s=u.useContext(I);return e&&s?s:o},A=u.createContext(void 0),N=A.Provider,k=n=>new Promise(e=>setTimeout(e,n)),C={pending:1e3,succeeded:1500,failed:2e3};class x{constructor(){a(this,"showFeedback");a(this,"state","isIdle");a(this,"setPendingTimeout");a(this,"error");a(this,"isAsync",!1);w(this,{state:g,updateState:m,isBusy:P})}static useNew(){return u.useRef(new x).current}updateState(e){this.state=e}useValue(){return y(()=>this.state,[this])}useIsBusy(){return y(()=>this.isBusy,[this])}get isBusy(){return this.state==="isExecuting"||this.state==="isPending"}onAsyncStart(){this.isAsync=!0,this.updateState("isExecuting"),this.setPendingTimeout=window.setTimeout(()=>this.startPending(),C.pending)}async onSucceeded(){await this.onDone()}async onFailed(e){this.error=e??new Error("Unknown error"),await this.onDone()}withFeedback(e){return this.showFeedback=e,this}async startFailedFeedback(){this.updateState("isFailed"),await k(C.failed),this.resetAfterDone()}async startSucceededFeedback(){this.updateState("isSucceeded"),await k(C.succeeded),this.resetAfterDone()}resetAfterDone(){this.updateState("isIdle"),this.isAsync=!1,this.error=void 0}async onDone(){this.setPendingTimeout&&window.clearTimeout(this.setPendingTimeout),this.error?await this.startFailedFeedback():this.showFeedback!==!1&&(this.showFeedback||this.isAsync)?await this.startSucceededFeedback():this.resetAfterDone()}startPending(){this.updateState("isPending")}}const M=n=>(...e)=>{const t=[...n],o=t.shift();if(o){const s=o(...e),r=()=>t.length===0?s:M(t)(...e);return s instanceof Promise?s.then(r):r()}},h=()=>{},z=(n,e={})=>{const{onSync:t=h,onAsync:o=h,then:s=h,catch:r=h,finally:l=h}=e;try{const c=n();return c instanceof Promise?(o(),c.then(s).catch(r).finally(l)):(t(),s(c),l(),c)}catch(c){t(),r(c),l()}},U=()=>{};function j(n){if(n.needsConfirmation)return n.confirmationModalController.open;const e=n.getOverlayController(),{action:t,toggleOverlay:o,closeOverlay:s,openOverlay:r}=n.actionProps;return t||(r&&e?e.open:s&&e||o&&e?e.close:U)}class B{constructor(e){a(this,"actions",[]);a(this,"baseAction");this.baseAction=e}addAction(e){this.actions.push(e)}async executeBatch(e){if(this.actions.length===0)return;const t=this.actions[this.actions.length-1].actionProps.showFeedback,o=this.baseAction.state.withFeedback(this.baseAction.needsConfirmation?!1:t),s=this.actions.map(c=>j(c)),r=M(s);let l;if(await z(()=>r(...e),{onAsync:()=>o.onAsyncStart(),then:()=>o.onSucceeded(),catch:c=>{o.onFailed(c),l=c}}),l)throw l}}class H{constructor(e){a(this,"action");a(this,"execute",(...e)=>{const t=this.getBatchedActions();(async()=>{for(const s of t)await s.executeBatch(e)})().catch(s=>console.error(s))});a(this,"getBatchedActions",()=>{let e=this.action;const t=[];let o=new B(this.action),s=0;for(;e;){const{action:r,break:l,skip:c}=e.actionProps;if(e.needsConfirmation){o.addAction(e);break}if(c){s=c===!0?1:c,e=e.parentAction;continue}if(s>0){e=e.parentAction,s--;continue}if(l)break;r||(t.push(o),o=new B(this.action)),o.addAction(e),e=e.parentAction}return t.push(o),t});this.action=e}}class p{constructor(){a(this,"states",new Set);w(this,{states:g,addState:m,removeState:m,isBusy:P})}static useNew(){return u.useRef(new p).current}static useRegisterState(e){const t=R();u.useEffect(()=>(t==null||t.addState(e),()=>{t==null||t.removeState(e)}),[t,e])}addState(e){this.states.add(e)}removeState(e){this.states.delete(e)}useIsBusy(){return y(()=>this.isBusy,[this.states.size])}get isBusy(){for(const e of this.states)if(e.isBusy)return!0;return!1}}const T=u.createContext(void 0),D=n=>{const{children:e}=n,t=p.useNew();return i.createElement(T.Provider,{value:t},e)},R=()=>{const n=p.useNew();return u.useContext(T)??n};D.__docgenInfo={description:"",methods:[],displayName:"ActionStateContextProvider"};class d{constructor(e){a(this,"state");a(this,"needsConfirmation");a(this,"actionProps");a(this,"parentAction");a(this,"confirmationModalController");a(this,"overlayController");a(this,"execute",(...e)=>{new H(this).execute(...e)});const{actionProps:t,needsConfirmation:o,parentAction:s,overlayController:r,confirmationModalController:l,state:c}=e;this.actionProps=t,this.parentAction=s,this.confirmationModalController=l,this.needsConfirmation=o,this.overlayController=r,this.state=c}static useNew(e,t={}){const o=u.useContext(A),s=E(),r=E(),l=x.useNew();return new d({parentAction:o,overlayController:s,confirmationModalController:r,needsConfirmation:!1,actionProps:e,state:l,...t})}static use(){const e=u.useContext(A);return L(!!e,"Action context is not defined"),p.useRegisterState(e.state),e}static useConfirmationAction(){const e=d.use();return new d({actionProps:e.actionProps,confirmationModalController:e.confirmationModalController,overlayController:e.overlayController,state:e.state,needsConfirmation:!1,parentAction:d.useNew({closeOverlay:!0},{parentAction:e.parentAction})})}getOverlayController(){const e=t=>t===void 0?void 0:t===!0?this.overlayController:t===!1?void 0:t;return e(this.actionProps.openOverlay)??e(this.actionProps.closeOverlay)??e(this.actionProps.toggleOverlay)}}const O=(n,e)=>{const t=d.use(),o=t.state.useValue(),s=R().useIsBusy();return t.confirmationModalController.useIsOpen()&&t.needsConfirmation?i.createElement(n,{...e,onPress:t.execute}):i.createElement(n,{onPress:t.execute,isPending:o==="isPending","aria-disabled":o==="isExecuting"||s,isSucceeded:o==="isSucceeded",isFailed:o==="isFailed",...e})};O.__docgenInfo={description:"",methods:[],displayName:"ActionButton"};const q=(n,e)=>{const t=d.use(),o=t.state.useValue();return t.needsConfirmation?i.createElement(n,{...e,onPress:t.execute}):i.createElement(n,{...e,onPress:t.execute,"aria-disabled":o!=="isIdle"})};q.__docgenInfo={description:"",methods:[],displayName:"ActionLink"};const _=(n,e)=>{const t=d.useConfirmationAction(),o=e.color==="secondary";if(!(e.color==="primary"||e.color==="danger"||e.color==="accent")&&!o)return i.createElement(n,{...e});const r={Button:{render:O}};return o?i.createElement(f,{props:r,mergeInParentContext:!0},i.createElement(v,{break:!0},i.createElement(v,{closeOverlay:!0},i.createElement(n,{...e})))):i.createElement(f,{props:r,mergeInParentContext:!0},i.createElement(N,{value:t},i.createElement(n,{...e})))};_.__docgenInfo={description:"",methods:[],displayName:"ConfirmationModalButton"};const S=(n,e)=>i.createElement(n,{...e},i.createElement(D,null,e.children));S.__docgenInfo={description:"",methods:[],displayName:"ActionGroup"};const G=(n,e)=>{const t=d.use();t.needsConfirmation=e.slot==="actionConfirm";const o=t.state.useIsBusy(),s=t.needsConfirmation?t.confirmationModalController:t.getOverlayController(),r=o?!1:e.isDismissable;return i.createElement(n,{...e,isDismissable:r,controller:s??e.controller},i.createElement(F,{if:t.needsConfirmation},i.createElement(f,{props:{ButtonGroup:{render:S,Button:{render:_}}},mergeInParentContext:!0},e.children)))};G.__docgenInfo={description:"",methods:[],displayName:"ActionModal"};const v=n=>{const{children:e,...t}=n,o=d.useNew(t),s=!o.parentAction,r={Modal:{render:G},ButtonGroup:{render:S},Button:{render:O},Link:{render:q}};return i.createElement(N,{value:o},i.createElement(F,{if:s},i.createElement(f,{props:r,dependencies:[o],mergeInParentContext:!0},e)))};v.__docgenInfo={description:"",methods:[],displayName:"Action",props:{action:{required:!1,tsType:{name:"signature",type:"function",raw:"(...args: unknown[]) => unknown",signature:{arguments:[{type:{name:"Array",elements:[{name:"unknown"}],raw:"unknown[]"},name:"args",rest:!0}],return:{name:"unknown"}}},description:""},closeOverlay:{required:!1,tsType:{name:"union",raw:"boolean | OverlayController",elements:[{name:"boolean"},{name:"OverlayController"}]},description:""},openOverlay:{required:!1,tsType:{name:"union",raw:"boolean | OverlayController",elements:[{name:"boolean"},{name:"OverlayController"}]},description:""},toggleOverlay:{required:!1,tsType:{name:"union",raw:"boolean | OverlayController",elements:[{name:"boolean"},{name:"OverlayController"}]},description:""},break:{required:!1,tsType:{name:"boolean"},description:""},skip:{required:!1,tsType:{name:"union",raw:"number | boolean",elements:[{name:"number"},{name:"boolean"}]},description:""},showFeedback:{required:!1,tsType:{name:"boolean"},description:""}},composes:["PropsWithChildren"]};export{v as A,ee as O,y as a,E as u};
